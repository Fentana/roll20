!function(shaped){function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function HandleInput(e){if(shaped.settings.useAmmoAutomatically&&"5eDefault"===e.rolltemplate&&-1!==e.content.indexOf("{{ammo_auto=1}}")){for(var t,a,r,i=/\{\{(.*?)\}\}/gi;r=i.exec(e.content);)if(r[1]){var s=r[1].split("=");"character_name"===s[0]&&(t=s[1]),"ammo_field"===s[0]&&(a=s[1])}shaped.decrementAmmo(t,a)}if("api"===e.type){log("msg.content: "+e.content);var n=e.content.split(/\s+--/);switch(n[0]){case"!build-monster":case"!shaped-parse":case"!shaped-import":n[1]&&"clean"===n[1]&&shaped.getSelectedToken(e,shaped.deleteOldSheet),shaped.getSelectedToken(e,shaped.importStatblock);break;case"!shaped-rollhp":shaped.getSelectedToken(e,shaped.rollTokenHp);break;case"!shaped-settings":n.shift(),shaped.changeSettings(n);break;case"!shaped-spell":n.shift(),shaped.getSelectedToken(e,shaped.spellImport,n);break;case"!shaped-convert":shaped.getSelectedToken(e,shaped.parseOldToNew);break;case"!shaped-token-macro":shaped.getSelectedToken(e,shaped.tokenMacros,n)}}}function capitalizeEachWord(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}function createInitTokenAction(e){setAbility("Init","","%{"+e+"|Initiative}",shaped.settings.createAbilityAsToken)}function createSaveQueryTokenAction(e){setAbility("Save","","%{"+e+"|save_query_macro}",shaped.settings.createAbilityAsToken)}function createCheckQueryTokenAction(e){setAbility("Check","","%{"+e+"|check_query_macro}",shaped.settings.createAbilityAsToken)}function createSkillQueryTokenAction(e){setAbility("Skill","","%{"+e+"|skill_query_macro}",shaped.settings.createAbilityAsToken)}function rollCharacterHp(e,t){for(var a=[4,6,8,10,12,20],r="",i=0,s=0,n=0;n<a.length;n++){var o=parseInt(getAttrByName(e,"hd_d"+a[n],"current"),10);o&&(""!==r&&(r+=" + "),i+=o,r+=o+"d"+a[n],s+=(a[n]/2+.5)*o)}var c=i*Math.floor((getAttrByName(e,"constitution","current")-10)/2);r+=" + "+c,s+=c,s=Math.floor(s),sendChat("GM","/roll "+r,function(e){var a=JSON.parse(e[0].content);_.has(a,"total")&&t(a.total,s,r)})}function setUserDefinedScriptSettings(){shaped.settings.defaultTab&&setAttribute("tab",shaped.settings.defaultTab),"hidden"===shaped.settings.sheetOutput&&setAttribute("output_option","@{output_to_gm}"),shaped.settings.whisperDeathSaves&&setAttribute("death_save_output_option","@{output_to_gm}"),shaped.settings.whisperInitiative&&setAttribute("initiative_output_option","@{output_to_gm}"),shaped.settings.showCharacterNameOnRollTemplate&&setAttribute("show_character_name","@{show_character_name_yes}"),shaped.settings.initiativeTieBreaker&&setAttribute("initiative_tie_breaker","((@{initiative_overall}) / 100)"),shaped.settings.initiativeAddsToTracker&&setAttribute("initiative_to_tracker","@{initiative_to_tracker_yes}"),shaped.settings.attacksVsTargetAC&&setAttribute("attacks_vs_target_ac","@{attacks_vs_target_ac_yes}"),shaped.settings.hideGMInfo&&(setAttribute("hide_save_dc","@{hide_save_dc_var}"),setAttribute("hide_save_failure","@{hide_save_failure_var}"),setAttribute("hide_save_success","@{hide_save_success_var}"),setAttribute("hide_effects","@{hide_effects_var}"),setAttribute("hide_recharge","@{hide_recharge_var}"))}function logObject(e){for(var t in e)e.hasOwnProperty(t)?logObject(e[t]):log("logObj: "+t+"->"+e[t])}function sortNumber(e,t){return e-t}function setAttribute(e,t,a){if(!e)throw"Name required to set attribute";if(a=a||"",!t)return void log("Error setting empty value: "+e);var r=findObjs({_type:"attribute",_characterid:characterId,name:e})[0];r?r.get("current")&&r.get("current").toString()===t||r.set({current:t,max:a}):createObj("attribute",{name:e,current:t,max:a,characterid:characterId})}function setAbility(e,t,a,r){if(!e)throw"Name required to set ability";var i=findObjs({_type:"ability",_characterid:characterId,name:e});if(!i)throw"Something prevent script to create or find ability "+e;0===i.length?(i=createObj("ability",{_characterid:characterId,name:e,description:t,action:a,istokenaction:r}),log("Ability "+e+" created")):(i=getObj("ability",i[0].id),(i.get("description")!=t||i.get("action")!==a||i.get("istokenaction")!=r)&&(i.set({description:t,action:a,istokenaction:r}),log("Ability "+e+" updated")))}function clean(e){return unescape(e).replace(/\s\./g,".").replace(/–/g,"-").replace(/<br[^>]*>/g,"#").replace(/\s*#\s*/g,"#").replace(/(<([^>]+)>)/gi,"").replace(/#(?=[a-z]|DC)/g," ").replace(/\s+/g," ").replace(/#Hit:/gi,"Hit:").replace(/Hit:#/gi,"Hit: ").replace(/#Each /gi,"Each ").replace(/#On a successful save/gi,"On a successful save").replace(/DC#(\d+)/g,"DC $1").replace("LanguagesChallenge","Languages -#Challenge").replace("' Speed","Speed").replace(/#Medium or/gi," Medium or").replace(/take#(\d+)/gi,"take $1")}function sanitizeText(e){"string"!=typeof e&&(e=e.toString()),e=e.replace(/\,\./gi,",").replace(/ft\s\./gi,"ft.").replace(/ft\.\s\,/gi,"ft").replace(/ft\./gi,"ft").replace(/(\d+) ft\/(\d+) ft/gi,"$1/$2 ft").replace(/lOd/g,"10d").replace(/dl0/gi,"d10").replace(/dlO/gi,"d10").replace(/dl2/gi,"d12").replace(/Sd(\d+)/gi,"5d$1").replace(/ld(\d+)/gi,"1d$1").replace(/ld\s+(\d+)/gi,"1d$1").replace(/(\d+)d\s+(\d+)/gi,"$1d$2").replace(/(\d+)\s+d(\d+)/gi,"$1d$2").replace(/(\d+)\s+d(\d+)/gi,"$1d$2").replace(/(\d+)d(\d)\s(\d)/gi,"$1d$2$3").replace(/(\d+)j(?:Day|day)/gi,"$1/Day").replace(/(\d+)f(?:Day|day)/gi,"$1/Day").replace(/(\d+)j(\d+)/gi,"$1/$2").replace(/(\d+)f(\d+)/gi,"$1/$2").replace(/{/gi,"(").replace(/}/gi,")").replace(/(\d+)\((\d+) ft/gi,"$1/$2 ft").replace(/• /gi,"").replace(/’/gi,"'"),e=e.replace(/(\d+)\s*?plus\s*?((?:\d+d\d+)|(?:\d+))/gi,"$2 + $1");var t={jday:"/day","abol eth":"aboleth","ACT IONS":"ACTIONS",Afrightened:"A frightened",Alesser:"A lesser",Aundefinedr:"After","blindn ess":"blindness","blind sight":"blindsight",bofh:"both","brea stplate":"breastplate","choos in g":"choosing","com muni cate":"communicate","Constituti on":"Constitution","creatu re":"creature","darkvi sion":"darkvision","dea ls":"deals","di sease":"disease","di stance":"distance","fa lls":"falls","fe et":"feet","exha les":"exhales","ex istence":"existence",lfthe:"If the",Ifthe:"If the",lnt:"Int","magica lly":"magically",minlilte:"minute","natura l":"natural",ofeach:"of each",ofthe:"of the","on'e":"one","0n":"on","pass ive":"passive","Perce ption":"Perception","radi us":"radius","ra nge":"range","rega ins":"regains","rest.oration":"restoration","savin g":"saving","si lvery":"silvery","s lashing":"slashing","slas hing":"slashing","slash in g":"slashing","slash ing":"slashing","Spel/casting":"Spellcasting","successfu l":"successful","ta rget":"target"," Th e ":" The ",t_urns:"turns","unti l":"until","withi n":"within"},a=new RegExp(Object.keys(t).join("|"),"gi");return e=e.replace(a,function(e){return t[e]})}function findKeyword(e){for(var t={attr:{},traits:{},actions:{},lair:{},legendary:{},reactions:{}},a=0,r=e.length,i=e.length,s=e.length,n=/#\s*(tiny|small|medium|large|huge|gargantuan|armor class|hit points|speed|str|dex|con|int|wis|cha|saving throws|skills|damage resistances|damage immunities|condition immunities|damage vulnerabilities|senses|languages|challenge|traits|actions|lair actions|legendary actions|reactions)(?=\s|#)/gi;match=n.exec(e);){var o=match[1].toLowerCase();"actions"===o?(a=match.index,t.actions.Actions=match.index):"legendary actions"===o?(i=match.index,t.legendary.Legendary=match.index):"reactions"===o?(s=match.index,t.reactions.Reactions=match.index):"lair actions"===o?(r=match.index,t.lair.Lair=match.index):t.attr[o]=match.index}for(n=/(?:#)([A-Z][\w-\']+(?:\s(?:[A-Z][\w-\']+|[\(\)\/\d\-]|of|and|or|a)+)*)(?=\s*\.)/gi,log("parsed statblock: "+e);match=n.exec(e);)t.attr[match[1].toLowerCase()]||(match.index<a?t.traits[match[1]]=match.index:match.index>a&&match.index<i&&match.index<s&&match.index<r?t.actions[match[1]]=match.index:match.index>i&&match.index<s&&match.index<r?t.legendary[match[1]]=match.index:match.index>s&&match.index<r?t.reactions[match[1]]=match.index:match.index>r&&(t.lair[match[1]]=match.index));var c=e.split("#"),l="",h=[],d=1;for(var u in t.actions)t.actions.hasOwnProperty(u)&&h.push(t.actions[u]);for(var g in t.legendary)t.legendary.hasOwnProperty(g)&&h.push(t.legendary[g]);for(var _ in t.lair)t.lair.hasOwnProperty(_)&&h.push(t.lair[_]);h.sort(sortNumber);for(var p,m=h[h.length-1]+1;6>d;)l=c[c.length-d],p=e.indexOf(l),p>m&&(t.traits.Description=p-1),d++;return t}function splitStatblock(e,t){var a=[];for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];for(var s in i)i.hasOwnProperty(s)&&a.push(i[s])}a.sort(sortNumber),t.attr.name=extractSection(e.substring(0,a[0]),"name");for(var r in t)if(t.hasOwnProperty(r)){var i=t[r];for(var s in i)if(i.hasOwnProperty(s)){var n=i[s],o=a.indexOf(n)+1,c=a[o]||e.length;t[r][s]=extractSection(e.substring(n,c),s)}}delete t.actions.Actions,delete t.legendary.Legendary,delete t.reactions.Reactions;for(var l=["str","dex","con","int","wis","cha"],h="",d=0,u=l.length;u>d;++d)t.attr.hasOwnProperty([l[d]])&&(h+=t.attr[l[d]]+" ",delete t.attr[l[d]]);t.attr.abilities=h;var g=["tiny","small","medium","large","huge","gargantuan"];for(d=0,u=g.length;u>d;++d)if(t.attr.hasOwnProperty([g[d]])){t.attr.size=g[d]+" "+t.attr[g[d]],delete t.attr[g[d]];break}return t}function extractSection(e,t){return e.replace(new RegExp("^[\\s\\.#]*"+t.replace(/([-()\\/])/g,"\\$1")+"?[\\s\\.#]*","i"),"").replace(/#/g," ")}function processSection(e){e.attr.abilities&&parseAbilities(e.attr.abilities),e.attr.size&&parseSize(e.attr.size),e.attr["armor class"]&&parseArmorClass(e.attr["armor class"]),e.attr["hit points"]&&parseHp(e.attr["hit points"]),e.attr.speed&&parseSpeed(e.attr.speed),e.attr.challenge&&parseChallenge(e.attr.challenge),e.attr["saving throws"]&&parseSavingThrow(e.attr["saving throws"]),e.attr.skills&&parseSkills(e.attr.skills),e.attr.senses&&parseSenses(e.attr.senses),e.attr["damage immunities"]&&setAttribute("damage_immunity",e.attr["damage immunities"]),e.attr["condition immunities"]&&setAttribute("condition_immunity",e.attr["condition immunities"]),e.attr["damage vulnerabilities"]&&setAttribute("damage_vulnerability",e.attr["damage vulnerabilities"]),e.attr["damage resistances"]&&setAttribute("damage_resistance",e.attr["damage resistances"]),e.attr.languages&&setAttribute("prolanguages",e.attr.languages),parseTraits(e.traits),parseReactions(e.reactions),parseActions(e.actions),parseActions(e.legendary,"legendary_"),parseActions(e.lair,"lair_")}function parseAbilities(e){for(var t=/(\d+)\s*\(/g,a=[];matches=t.exec(e);)a.push(matches[1]);setAttribute("strength",a[0]),setAttribute("dexterity",a[1]),setAttribute("constitution",a[2]),setAttribute("intelligence",a[3]),setAttribute("wisdom",a[4]),setAttribute("charisma",a[5])}function parseSize(e){var t=e.match(/(.*?) (.*?), (.*)/i);if(!(t&&t[1]&&t[2]&&t[3]))throw"Character doesn't have valid type/size/alignment format";setAttribute("size",capitalizeEachWord(t[1])),setAttribute("npc_type",capitalizeEachWord(t[2])),setAttribute("alignment",capitalizeEachWord(t[3]))}function parseArmorClass(e){var t=e.match(/(\d+)\s?(.*)/);if(!t||!t[1])throw"Character doesn't have valid AC format";setAttribute("npc_AC",t[1]),t[2]&&setAttribute("npc_AC_note",t[2].replace(/\(|\)/g,""))}function parseHD(e){for(var t,a=/(\d+)d(\d+)/gi;t=a.exec(e);){if(!t||!t[1]||!t[2])throw"Character doesn't have valid hd format";var r=t[1],i="d"+t[2];setAttribute("hd_"+i,r,r),setAttribute("hd_"+i+"_toggle","on")}}function parseHp(e){var t=e.match(/(\d+)\s?\(([\dd\s\+\-]*)\)/i);if(!t||!t[1]||!t[2])throw"Character doesn't have valid HP/HD format";setAttribute("HP",t[1],t[1]),setAttribute("npc_HP_hit_dice",t[2]),parseHD(t[2])}function parseSpeed(e){for(var t="speed",a=/(|burrow|climb|fly|swim|)\s*(\d+)\s*?(?:ft)?\s*(\(.*\))?/gi;match=a.exec(e);){if(!match[2])throw"Character doesn't have valid speed format";var r=t+(""!==match[1]?"_"+match[1].toLowerCase():""),i=match[2];match[3]&&match[3].indexOf("hover")&&setAttribute("speed_fly_hover","on"),setAttribute(r,i)}}function parseSenses(e){e=e.replace(/[,\s]*passive.*/i,"");for(var t=/(|blindsight|darkvision|tremorsense|truesight|)\s*?(\d+)\s*?ft?\s*(\(.*\))?/gi;match=t.exec(e);){if(!match||!match[1]||!match[2])throw"Character doesn't have valid senses format";var a=match[1].toLowerCase(),r=match[2];match[3]&&match[3].indexOf("blind beyond")&&setAttribute("blindsight_blind_beyond","on"),setAttribute(a,r)}}function setTokenVision(e){var t,a,r=parseInt(getAttrByName(characterId,"blindsight"),10)||0,i=parseInt(getAttrByName(characterId,"darkvision"),10)||0,s=parseInt(getAttrByName(characterId,"tremorsense"),10)||0,n=parseInt(getAttrByName(characterId,"truesight"),10)||0,o=Math.max(r,i,s,n),c=Math.max(r,s,n);o===r?(t=r,a=r):o===s?(t=s,a=s):o===n?(t=n,a=n):o===i&&(t=Math.ceil(1.1666666*i),a=c>0?c:-5),t>0&&e.set("light_radius",t),a&&e.set("light_dimradius",a),e.set("light_hassight",!0),e.set("light_angle",360),e.set("light_losangle",360)}function parseChallenge(e){var t=e.replace(/[, ]/g,""),a=t.match(/([\d/]+).*?(\d+)/);setAttribute("challenge",a[1]);var r=parseInt(a[2]);getAttrByName(characterId,"xp")!==r&&setAttribute("xp",r)}function parseSavingThrow(save){for(var regex=/(STR|DEX|CON|INT|WIS|CHA).*?(\d+)/gi,attr;match=regex.exec(save);){switch(match[1].toLowerCase()){case"str":attr="strength";break;case"dex":attr="dexterity";break;case"con":attr="constitution";break;case"int":attr="intelligence";break;case"wis":attr="wisdom";break;case"cha":attr="charisma"}setAttribute(attr+"_save_prof","@{PB}");var proficiencyBonus=2+Math.floor(Math.abs((eval(getAttrByName(characterId,"challenge"))-1)/4)),totalSaveBonus=match[2]-proficiencyBonus-Math.floor((getAttrByName(characterId,attr)-10)/2);0!==totalSaveBonus&&setAttribute(attr+"_save_bonus",totalSaveBonus)}}function parseSkills(skills){for(var skillAbility={acrobatics:"dexterity","animal handling":"wisdom",arcana:"intelligence",athletics:"strength",deception:"charisma",history:"intelligence",insight:"wisdom",intimidation:"charisma",investigation:"intelligence",medicine:"wisdom",nature:"intelligence",perception:"wisdom",performance:"charisma",persuasion:"charisma",religion:"intelligence","sleight of hand":"dexterity",stealth:"dexterity",survival:"wisdom"},extraSkillAbility={"alchemist's supplies":"intelligence","navigator's tools":"wisdom","thieves' tools":"dexterity"},regex=/([\w\s\']+).*?(\d+)/gi,customSkillNum=0;match=regex.exec(skills.replace(/Skills\s+/i,""));){var skill=match[1].trim().toLowerCase(),proficiencyBonus=2+Math.floor(Math.abs((eval(getAttrByName(characterId,"challenge"))-1)/4)),expertise=2*proficiencyBonus;if(skill in skillAbility){var abilitymod=skillAbility[skill],attr=skill.replace(/\s/g,""),totalSkillBonus=match[2]-Math.floor((getAttrByName(characterId,abilitymod)-10)/2);totalSkillBonus>=expertise?(setAttribute(attr+"_prof_exp","@{exp}"),totalSkillBonus>expertise&&setAttribute(attr+"_bonus",totalSkillBonus-expertise)):totalSkillBonus>=proficiencyBonus?(setAttribute(attr+"_prof_exp","@{PB}"),totalSkillBonus>proficiencyBonus&&setAttribute(attr+"_bonus",totalSkillBonus-proficiencyBonus)):(setAttribute(attr+"_prof_exp","@{jack_of_all_trades}"),totalSkillBonus>0&&setAttribute(attr+"_bonus",totalSkillBonus))}else if(skill in extraSkillAbility){customSkillNum++;var abilitymod=extraSkillAbility[skill],attr="custom_skill_"+customSkillNum,totalSkillBonus=match[2]-Math.floor((getAttrByName(characterId,abilitymod)-10)/2);setAttribute(attr+"_name",capitalizeEachWord(skill)),log("added "+capitalizeEachWord(skill)+" to custom skills"),totalSkillBonus>=expertise?(setAttribute(attr+"_prof_exp","@{exp}"),totalSkillBonus>expertise&&setAttribute(attr+"_bonus",totalSkillBonus-expertise)):totalSkillBonus>=proficiencyBonus?(setAttribute(attr+"_prof_exp","@{PB}"),totalSkillBonus>proficiencyBonus&&setAttribute(attr+"_bonus",totalSkillBonus-proficiencyBonus)):(setAttribute(attr+"_prof_exp","@{jack_of_all_trades}"),totalSkillBonus>0&&setAttribute(attr+"_bonus",totalSkillBonus))}else errors.push("Skill "+skill+" is not a valid skill");customSkillNum>0&&setAttribute("custom_skills_toggle","on")}}function parseTraits(e){var t=[];if(_.each(e,function(e,a){t.push("**"+a+"**. "+e)}),t.length>0){var a=t.join("\n");setAttribute("npc_traits",a)}}function parseReactions(e){var t=[];_.each(e,function(e,a){t.push("**"+a+"**. "+e)}),t.length>0&&(setAttribute("reactions",t.join("\n")),setAttribute("toggle_reactions","on"))}function parseActions(e,t){function a(e){function a(e,a,r){"undefined"==typeof r&&(r=a),r&&setAttribute("repeating_"+t+"actions_"+N+"_"+e,a.trim())}function r(e,a){("undefined"==typeof a||a)&&setAttribute("repeating_"+t+"actions_"+N+"_toggle_"+e,"@{repeating_"+t+"actions_"+N+"_var_"+e+"}")}function i(e){return e.replace(/\s?[\+\-]\s?\d+/g,"")}function n(e){a("name",e)}function o(e){a("type",e)}function c(e){a("target",e),r("target")}function l(e){a("range",e),r("range")}function h(e,t){a(t+"dmg",e)}function d(e){r(e+"damage")}function u(e,t){a(t+"dmg_type",e)}function g(e,t){a(t+"crit_dmg",e)}function p(e){a("alt_dmg_reason",e)}function m(e){e&&a("effect",e.replace(/(\s*?Hit:\s?)/gi,"").replace(/(\d+)d(\d+)/g,"[[$1d$2]]").replace(/\s(\d+)\s/g," [[$1]] ")),r("effects",e)}function v(e){a("save_dc",e)}function f(e){e&&a("save_stat",e.substring(0,3))}function b(e){r("save",e)}function A(e){r("save_damage",e)}function y(e){a("save_dmg",e)}function k(e){a("save_dmg_type",e)}function C(e){a("save_success",e)}function w(e){m(e)}function x(e,t){e&&(e[1]&&(e[2]=e[1]),e[2]&&(h(e[2],t),g(i(e[2]),t)),e[4]&&(e[3]+=" "+e[4]),e[3]&&u(e[3],t),(e[2]||e[3])&&d(t),e[5]&&m(e[5].trim()),e[6]&&p(e[6]))}var N=0,P=[],S=/\,?\.?\s*?/,T=/\,?\.?\s*/,O=/\,?\.?\s?/,B=/Hit:.*?/,I=/((?:[\w]+|[\w]+\s(?:or|and)\s[\w]+)(?:\s*?\([\w\s]+\))?)\s*?damage\s?(\([\w\'\s]+\))?/,M=/(?:(\d+)|.*?\(([\dd\s\+\-]*)\).*?)\s*?/,F=/(?:\,\s*?or\s*?)/,D=/((?:if|in)[\w\s]+)/,H=/(The.*|If the.*)?/,L=/\s*?plus\s*?/,E=/(?:DC)\s*?(\d+)\s*?([a-zA-Z]*)\s*?(?:saving throw)/,R=/\,?\s*?(?:taking|or take)/,j=/(?: against disease)?/,G=/(?:.*or\s(.*)?\son a successful one.)?/,$=/(?:On a successful save,)?(.*)?/,z=/(?:On a (?:failure|failed save))\,\s(?:(.*). On a success,\s(.*)?)?(.*)?/,Q=/(\s?and.*)?/,q=/(or\s(?!take).*)/,U=/(.*)?/,W=new RegExp(B.source+M.source+I.source+S.source+Q.source,"i"),V=new RegExp(L.source+M.source+I.source+S.source+U.source,"i"),Z=new RegExp(F.source+M.source+I.source+S.source+D.source+O.source+H.source,"i"),K=new RegExp(B.source+U.source,"i"),J=new RegExp(E.source+R.source+M.source+I.source+G.source+S.source+U.source+$.source,"i"),X=new RegExp(E.source+j.source+T.source+q.source,"i"),Y=new RegExp(E.source+S.source+z.source,"i");_.each(e,function(e,i){function h(){setAbility(i,"","%{"+characterName+"|repeating_"+t+"actions_"+N+"_action}",shaped.settings.createAbilityAsToken)}var d,u=!1,g=!1,_=!1,p=i.indexOf("(");s[N]=p>1?i.substring(0,p-1).toLowerCase():i.toLowerCase();for(var S=/\s*?\((?:Recharge\s*?(\d+\-\d+|\d+)|Recharges\safter\sa\s(.*))\)/gi;keyResult=S.exec(i);){var T=keyResult[1]||keyResult[2];a("recharge",T),r("recharge"),T&&(i=i.replace(S,""))}for(var O=/\s*?\((\d+\/Day)\)/gi;rechargeDayResult=O.exec(i);){var T=rechargeDayResult[1]||rechargeDayResult[2];a("recharge",T),r("recharge"),T&&(i=i.replace(O,""))}n(i);for(var B=e.split(/\.(.+)?/),I=B[0],M=I.split(","),F=/(melee|ranged|melee or ranged)\s*(spell|weapon)\s*/gi;type=F.exec(M[0]);){if(type[1]){var D="Melee or Ranged";type[1].toLowerCase()===D.toLowerCase()&&(type[1]="Thrown"),o(capitalizeEachWord(type[1]))}if(type[2]){capitalizeEachWord(type[2])}u=!0}for(var H=/\+\s?(\d+)\s*(?:to hit)/gi;toHit=H.exec(M[0]);)toHit[1]&&(a("tohit",toHit[1]),r("attack"),r("crit")),M[2]&&c(M[2].trim().toLowerCase()),u=!0;for(var L=/(?:reach)\s?(\d+)\s?(?:ft)/gi;reach=L.exec(M[1]);)reach[1]&&(a("reach",reach[1]+" ft",reach[1]),r("reach")),u=!0;for(var E=/(?:range)\s?(\d+)\/(\d+)\s?(ft)/gi;range=E.exec(M[1]);)range[1]&&range[2]&&l(range[1]+"/"+range[2]+" ft"),u=!0;var R=W.exec(e);if(R)x(R,"");else{var j=K.exec(e);j&&j[1]&&m(j[1].trim())}var G=V.exec(e);G&&x(G,"second_");var $=Z.exec(e);$&&($[6]=[$[5],$[5]=$[6]][0],x($,"alt_"));var R=W.exec(e);z&&x(R,"");var z=J.exec(e);z&&(z[1]&&v(z[1]),z[2]&&f(z[2]),z[3]&&(z[4]=z[3]),z[4]&&y(z[4]),z[6]&&(z[5]+=" "+z[6]),z[5]&&k(z[5]),z[9]&&(z[7]=z[9]),z[7]&&C(z[7]),z[8]&&w(z[8]),(z[1]||z[2]||z[8])&&b(),(z[4]||z[5]||z[7])&&A(),g=!0);var Q=X.exec(e);Q&&(Q[1]&&v(Q[1]),Q[2]&&f(Q[2]),Q[3]&&w(Q[3]),(Q[1]||Q[2]||Q[3])&&b(),g=!0);var q=Y.exec(e);q&&(q[1]&&v(q[1]),q[2]&&f(q[2]),q[5]&&(q[3]=q[5]),q[3]&&w(q[3]),q[4]&&C(q[4]),(q[1]||q[2]||q[3]||q[4])&&b(),g=!0);for(var U=/((?:Each | a | an | one ).*(?:creature|target).*)\s(?:within|in)\s*?a?\s*?(\d+)\s*?(?:feet|ft)/gi;saveRange=U.exec(e);)saveRange[1]&&c(saveRange[1].trim()),saveRange[2]&&l(saveRange[2]+" ft",saveRange[2]);var ee=/(\d+)\-foot line\s*?that is (\d+) feet wide/gi,te=ee.exec(e),ae=/line that is (\d+)\sfeet long\s*?and (\d+) feet wide/gi,re=ae.exec(e),ie=te||re;ie&&(o("Line"),ie[1]&&ie[2]?l(ie[1]+"-foot line that is "+ie[2]+" feet wide"):ie[1]&&l(ie[1]));for(var se=/\.\s*(.*in that line)/gi;lineTarget=se.exec(e);)c(lineTarget[1]);d=u||_||g,d?("legendary_"===t&&P.push(i+". See below"),i.indexOf("Costs ")>0&&(i=i.replace(/\s*\(Costs\s*\d+\s*Actions\)/gi,""),n(i)),h(),N++):"legendary_"===t?P.push(i+". "+e):(m(e),h(),N++)}),P.length>0&&setAttribute("legendary_action_notes",P.join("\n"))}function r(e){""!==d&&(d+="\n"),d+="%{"+characterName+"|repeating_actions_"+e+"_action}"}t||(t="");var i,s=[];shaped.settings.addInitiativeTokenAbility&&createInitTokenAction(characterName),shaped.settings.addSaveQueryMacroTokenAbility&&createSaveQueryTokenAction(characterName),shaped.settings.addCheckQueryMacroTokenAbility&&createCheckQueryTokenAction(characterName),shaped.settings.addSkillQueryMacroTokenAbility&&createSkillQueryTokenAction(characterName);for(var n in e){var o=/Multiattack(?:\s*(\(.*\)))?/gi,c=o.exec(n),i="";if(c){c[1]&&(i=c[1]+": "),i+=e[n],setAttribute("multiattack",i),delete e[n],setAttribute("toggle_multiattack","on"),setAbility("MultiAtk","","%{"+characterName+"|multiattack}",shaped.settings.createAbilityAsToken);break}}if(a(e),"lair_"===t&&Object.keys(e).length>0&&setAttribute("toggle_lair_actions","on"),"legendary_"===t&&Object.keys(e).length>0&&setAttribute("toggle_legendary_actions","on"),i){for(var l,h=s.join("|"),o=new RegExp("(one|two|three)? (?:with its )?("+h+")( or)?","gi"),d="";match=o.exec(i);){var u=match[2],g=match[1]||"one";l=s.indexOf(u.toLowerCase()),-1!==l&&(r(l),"two"==g&&r(l),"three"==g&&r(l),match[3]&&(d+="or\n"),delete s[l])}setAttribute("multiattack_script",d)}}function parseActionsForConvert(){for(var e={},t={},a={},r=[],i=1;20>=i;i++){var s=getAttrByName(characterId,"npc_action_name"+i,"current"),n=getAttrByName(characterId,"npc_action_type"+i,"current"),o=getAttrByName(characterId,"npc_action_description"+i,"current"),c=getAttrByName(characterId,"npc_action_effect"+i,"current"),l=o+" "+c;s&&(l=l.replace(/\s*?\:\s*?\[\[(\d+d\d+[\d\s+|\-]*)\]\]\s*?\|\s*?\[\[(\d+d\d+[\d\s+|\-]*)\]\]/gi,"").replace(/\[\[(\d*d\d+[\d\s+|\-]*)\]\]/gi,"$1"),1===n.indexOf("Bonus Action")?(log("Bonus Action "+s+" changed to a normal action"),e[s]=l):1===n.indexOf("Legendary Action")?(log("Legendary Action "+s),a[s]=l):1===n.indexOf("Reaction")?(log("Reaction "+s),r.push(l)):1===n.indexOf("Lair Action")?(log("Lair Action "+s),t[s]=l):1===n.indexOf("Special Action")?(log("Special Action "+s+" changed to a normal action"),e[s]=l):(log("Action "+s),e[s]=l))}Object.keys(e).length>0&&parseActions(e),Object.keys(a).length>0&&parseActions(a,"legendary_"),r.length>0&&(setAttribute("reactions",r.join("\n")),setAttribute("toggle_reactions","on")),Object.keys(t).length>0&&parseActions(t,"lair_")}function convertAttrFromNPCtoPC(e,t){var a=getAttrByName(characterId,e),r=getAttrByName(characterId,t);a&&!r&&(log("convert from "+e+" to "+t),a=sanitizeText(a),setAttribute(t,a))}function clearBar(e,t){e.set(t+"_link",""),e.set(t+"_value",""),e.set(t+"_max","")}function setBarValueAfterConvert(e){for(var t=0;3>t;t++){var a=shaped.settings.bar[t].name,r="bar"+(t+1);if(""!==a){var i,s,n,o=findObjs({name:a,_type:"attribute",_characterid:characterId},{caseInsensitive:!0})[0];o?(i=o.id,s=o.attributes.current,n=o.attributes.max):i="sheetattr_"+a,shaped.settings.bar[t].link?(log(r+": setting link to: "+i),e.set(r+"_link",i)):e.get(r+"_link")&&(log(r+": link isn't set in the bar settings, clearing link"),e.set(r+"_link","")),a?(log(r+": setting current to: "+s),e.set(r+"_value",s)):e.get(r+"_value")&&(log(r+": current isn't set in the bar settings, clearing current"),e.set(r+"_value","")),shaped.settings.bar[t].max?(log(r+": setting max to: "+n),e.set(r+"_max",n)):e.get(r+"_max")&&(log(r+": max isn't set in the bar settings, clearing max"),e.set(r+"_max",""))}else log(r+": no defined bar setting in shaped-scripts (at the top of the page), clearing "+r+"."),clearBar(e,r)}}shaped.settings={createAbilityAsToken:!0,rollMonsterHpOnDrop:!0,showName:!0,showNameToPlayers:!1,showCharacterNameOnRollTemplate:!1,sheetOutput:"",whisperDeathSaves:!0,initiativeTieBreaker:!0,whisperInitiative:!0,initiativeAddsToTracker:!0,addInitiativeTokenAbility:!0,attacksVsTargetAC:!1,attacksVsTargetName:!1,addSaveQueryMacroTokenAbility:!0,addCheckQueryMacroTokenAbility:!0,addSkillQueryMacroTokenAbility:!0,useAmmoAutomatically:!0,bar:[{name:"npc_AC",max:!1,link:!0,show:!1},{name:"",max:!1,link:!1,show:!1},{name:"HP",max:!0,link:!1,show:!1}]},shaped.statblock={version:"1.95",RegisterHandlers:function(){on("chat:message",HandleInput),shaped.settings.rollMonsterHpOnDrop&&on("add:graphic",function(e){shaped.rollTokenHp(e)}),log("Shaped Scripts ready")}};var status="",errors=[],obj=null,characterId=null,characterName=null;shaped.getSelectedToken=shaped.getSelectedToken||function(e,t){try{if(!e.selected||!e.selected.length)throw"No token selected";for(var a=0;a<e.selected.length;a++)if("graphic"===e.selected[a]._type){var r=getObj("graphic",e.selected[a]._id);r&&"token"===r.get("subtype")&&t(r,arguments[2])}}catch(i){log(i),log("Exception: "+i),sendChat("GM","/w GM "+i)}},shaped.deleteOldSheet=function(e){var t=e.get("represents"),a=findObjs({_type:"character",id:t})[0];a&&(a.remove(),log("old sheet removed before importing"))},shaped.tokenMacros=function(e,t){var a,r=e.get("represents"),i=findObjs({_type:"character",id:r})[0],s=getAttrByName(r,"character_name","current");if("undefined"==typeof i){var a='Error: cannot find a character by the name of "'+s+'".';return log(a),void sendChat("GM","/w gm "+a)}characterId=i.id,"init"===t[1]?(createInitTokenAction(s),a="created init token macro for "+s+".",log(a),sendChat("GM","/w gm "+a)):"query"===t[1]?(createSaveQueryTokenAction(s),createCheckQueryTokenAction(s),createSkillQueryTokenAction(s),a="created query token macros for "+s+".",log(a),sendChat("GM","/w gm "+a)):"bootstrap"===t[1]&&(createInitTokenAction(s),createSaveQueryTokenAction(s),createCheckQueryTokenAction(s),createSkillQueryTokenAction(s),a="bootstraped all token macros for "+s+".",log(a),sendChat("GM","/w gm "+a))},shaped.decrementAmmo=function(e,t){var a=findObjs({_type:"character",name:e})[0],r=findObjs({_type:"attribute",_characterid:a.id,name:t})[0],i=parseInt(r.get("current"),10)||0;r.set({current:i-1})},shaped.rollTokenHp=function(e){for(var t,a=0;3>a;a++)if("HP"===shaped.settings.bar[a].name){t=a+1;break}if(!t){var r='One of the bar names has to be set to "HP" for random HP roll';return log(r),void sendChat("GM","/w gm "+r)}var i="bar"+t,s=e.get("represents");if(""===s)log("Token does not represent a character");else if(""!==e.get(i+"_link"))log("Token "+i+" is linked");else{var n=getAttrByName(s,"is_npc","current");(1===n||"1"===n)&&rollCharacterHp(s,function(t,a,r){e.set(i+"_value",t),e.set(i+"_max",t);var s="HP ("+r+") | average: "+a+" | rolled: "+t;sendChat("GM","/w gm "+s)})}log("Still working after trying to roll hp")},shaped.setCharacter=function(e){if(!characterName)throw"Name require to get or create character";var t=findObjs({_type:"character",name:characterName});if(0===t.length?(t=createObj("character",{name:characterName}),status=characterName+" created"):(t=getObj("character",t[0].id),status=characterName+" updated"),!t)throw"Something prevent script to create or find character "+characterName;return e&&t.set({gmnotes:e}),characterId=t.id,1!==getAttrByName(characterId,"is_npc")&&setAttribute("is_npc",1),t},shaped.importStatblock=function(e){status="Nothing modified",errors=[];var t=e.get("gmnotes").trim();if(""===t)throw"Selected token GM Notes was empty.";if(shaped.parseStatblock(t),characterId){e.set("represents",characterId);var a=characterName;shaped.settings.useAaronsNumberedScript&&1!==characterName.indexOf("%%NUMBERED%%")&&(a+=" %%NUMBERED%%"),e.set("name",a),shaped.settings.showName&&e.set("showname",!0),shaped.settings.showNameToPlayers&&e.set("showplayers_name",!0),setUserDefinedScriptSettings(),setBarValueAfterConvert(e),shaped.settings.bar[0].show&&e.set("showplayers_bar1","true"),shaped.settings.bar[1].show&&e.set("showplayers_bar2","true"),shaped.settings.bar[2].show&&e.set("showplayers_bar3","true"),setTokenVision(e)}log(status),sendChat("Shaped","/w GM "+status),errors.length>0&&(log(errors.join("\n")),sendChat("Shaped","/w GM Error(s):\n/w GM "+errors.join("\n/w GM ")))},shaped.parseStatblock=function(e){log("---- Parsing statblock ----");var t=sanitizeText(clean(e)),a=findKeyword(t),r=splitStatblock(t,a);characterName=capitalizeEachWord(r.attr.name.toLowerCase()),shaped.setCharacter(t.replace(/#/g,"<br>")),processSection(r)},shaped.parseOldToNew=function(e){log("---- Parsing old attributes to new ----"),characterId=e.attributes.represents,convertAttrFromNPCtoPC("npc_initiative","initiative"),convertAttrFromNPCtoPC("npc_initiative_overall","initiative_overall"),convertAttrFromNPCtoPC("npc_strength","strength"),convertAttrFromNPCtoPC("npc_strength_save_bonus","strength_save_bonus"),convertAttrFromNPCtoPC("npc_basic_strength_bonus","basic_strength_bonus"),convertAttrFromNPCtoPC("npc_dexterity","dexterity"),convertAttrFromNPCtoPC("npc_dexterity_save_bonus","dexterity_save_bonus"),convertAttrFromNPCtoPC("npc_basic_dexterity_bonus","basic_dexterity_bonus"),convertAttrFromNPCtoPC("npc_constitution","constitution"),convertAttrFromNPCtoPC("npc_constitution_save_bonus","constitution_save_bonus"),convertAttrFromNPCtoPC("npc_basic_constitution_bonus","basic_constitution_bonus"),convertAttrFromNPCtoPC("npc_intelligence","intelligence"),convertAttrFromNPCtoPC("npc_intelligence_save_bonus","intelligence_save_bonus"),convertAttrFromNPCtoPC("npc_basic_intelligence_bonus","basic_intelligence_bonus"),convertAttrFromNPCtoPC("npc_wisdom","wisdom"),convertAttrFromNPCtoPC("npc_wisdom_save_bonus","wisdom_save_bonus"),convertAttrFromNPCtoPC("npc_basic_wisdom_bonus","basic_wisdom_bonus"),convertAttrFromNPCtoPC("npc_charisma","charisma"),convertAttrFromNPCtoPC("npc_charisma_save_bonus","charisma_save_bonus"),convertAttrFromNPCtoPC("npc_basic_charisma_bonus","basic_charisma_bonus"),convertAttrFromNPCtoPC("npc_alignment","alignment");var t=getAttrByName(characterId,"npc_HP"),a=getAttrByName(characterId,"HP"),r=getAttrByName(characterId,"npc_HP","max"),i=getAttrByName(characterId,"HP","max");t&&!a&&r&&!i?setAttribute("HP",t,r):t&&!a?setAttribute("HP",t):r&&!i&&setAttribute("HP",0,r),convertAttrFromNPCtoPC("npc_temp_HP","temp_HP");var s=getAttrByName(characterId,"npc_HP_hit_dice");s&&parseHD(s);var n=[],o=getAttrByName(characterId,"npc_speed"),c=getAttrByName(characterId,"npc_speed_fly"),l=getAttrByName(characterId,"npc_speed_climb"),h=getAttrByName(characterId,"npc_speed_swim");o&&(1!==o.indexOf("ft")&&(o+=" ft"),n.push(o)),c&&(1!==c.indexOf("ft")&&(c+=" ft"),n.push("fly "+c)),l&&(1!==l.indexOf("ft")&&(l+=" ft"),n.push("climb"+l)),h&&(1!==h.indexOf("ft")&&(h+=" ft"),n.push("swim"+h)),parseSpeed(n.join(", ")),convertAttrFromNPCtoPC("npc_xp","xp"),convertAttrFromNPCtoPC("npc_challenge","challenge"),convertAttrFromNPCtoPC("npc_size","size"),
parseSenses(sanitizeText(getAttrByName(characterId,"npc_senses"))),convertAttrFromNPCtoPC("npc_languages","prolanguages"),convertAttrFromNPCtoPC("npc_damage_resistance","damage_resistance"),convertAttrFromNPCtoPC("npc_damage_vulnerability","damage_vulnerability"),convertAttrFromNPCtoPC("npc_damage_immunity","damage_immunity"),convertAttrFromNPCtoPC("npc_condition_immunity","condition_immunity"),convertAttrFromNPCtoPC("npc_acrobatics_bonus","acrobatics_bonus"),convertAttrFromNPCtoPC("npc_animalhandling_bonus","animalhandling_bonus"),convertAttrFromNPCtoPC("npc_arcana_bonus","arcana_bonus"),convertAttrFromNPCtoPC("npc_athletics_bonus","athletics_bonus"),convertAttrFromNPCtoPC("npc_deception_bonus","deception_bonus"),convertAttrFromNPCtoPC("npc_history_bonus","history_bonus"),convertAttrFromNPCtoPC("npc_insight_bonus","insight_bonus"),convertAttrFromNPCtoPC("npc_intimidation_bonus","intimidation_bonus"),convertAttrFromNPCtoPC("npc_investigation_bonus","investigation_bonus"),convertAttrFromNPCtoPC("npc_medicine_bonus","medicine_bonus"),convertAttrFromNPCtoPC("npc_nature_bonus","nature_bonus"),convertAttrFromNPCtoPC("npc_perception_bonus","perception_bonus"),convertAttrFromNPCtoPC("npc_performance_bonus","performance_bonus"),convertAttrFromNPCtoPC("npc_persuasion_bonus","persuasion_bonus"),convertAttrFromNPCtoPC("npc_religion_bonus","religion_bonus"),convertAttrFromNPCtoPC("npc_sleightofhand_bonus","sleightofhand_bonus"),convertAttrFromNPCtoPC("npc_stealth_bonus","stealth_bonus"),convertAttrFromNPCtoPC("npc_survival_bonus","survival_bonus"),setUserDefinedScriptSettings(),parseActionsForConvert(),shaped.setBars(e),setTokenVision(e),shaped.settings.showName&&e.set("showname",!0),log("Character "+e.attributes.name+" converted"),sendChat("Shaped","/w gm Character "+e.attributes.name+" converted")},shaped.setBars=function(e){setBarValueAfterConvert(e)},shaped.changeSettings=function(e){function t(t,a,i,s){r===t&&(r=a+"_"+t,"show"===e[2]?n[r]=i:"hide"===e[2]&&(n[r]=s))}function a(t,a,i){r===t&&("yes"===e[2]?n[r]=a:"no"===e[2]&&(n[r]=i))}log(e);var r,i=!1,s=!1,n={};if("npcs"===e[0])i=!0;else if("pcs"===e[0])s=!0;else if("all"===e[0])i=!0,s=!0;else{var o="invalid target. Please send 'npcs', 'pcs', or 'all'";log(o),sendChat("GM","/w GM "+o)}var c=["output_option","death_save_output_option","initiative_output_option","show_character_name","initiative_tie_breaker","initiative_to_tracker","attacks_vs_target_ac","attacks_vs_target_name","gm_info","save_dc","save_failure","save_success","effects","recharge"];if(-1===c.indexOf(e[1])){var o="invalid attribute. Please use one of the following: "+c.join(", ");return log(o),void sendChat("GM","/w GM "+o)}r=e[1];var l=["hide","show","yes","no"];if(-1===l.indexOf(e[2])){var o="invalid value. Please use one of the following: "+l.join(", ");return log(o),void sendChat("GM","/w GM "+o)}("output_option"===r||"death_save_output_option"===r||"initiative_output_option"===r)&&("show"===e[2]?n[r]="@{output_to_all}":"hide"===e[2]&&(n[r]="@{output_to_gm}")),t("character_name","show","@{show_character_name_yes}","@{show_character_name_no}"),a("initiative_tie_breaker","((@{initiative_overall}) / 100)",""),a("initiative_to_tracker","@{initiative_to_tracker_yes}","@{initiative_to_tracker_no}"),a("attacks_vs_target_ac","@{attacks_vs_target_ac_yes}","@{attacks_vs_target_ac_no}"),a("attacks_vs_target_name","@{attacks_vs_target_name_yes}","@{attacks_vs_target_name_no}"),t("save_dc","hide","","@{hide_save_dc_var}"),t("save_failure","hide","","@{hide_save_failure_var}"),t("save_success","hide","","@{hide_save_success_var}"),t("effects","hide","","@{hide_effects_var}"),t("recharge","hide","","@{hide_recharge_var}"),"gm_info"===r&&("show"===e[2]?(n.hide_save_dc="",n.hide_save_failure="",n.hide_save_success="",n.hide_effects="",n.hide_recharge=""):"hide"===e[2]&&(n.hide_save_dc="@{hide_save_dc_var}",n.hide_save_failure="@{hide_save_failure_var}",n.hide_save_success="@{hide_save_success_var}",n.hide_effects="@{hide_effects_var}",n.hide_recharge="@{hide_recharge_var}"));var h=filterObjs(function(e){if("character"===e.get("type")){var t=parseInt(getAttrByName(e.id,"is_npc"),10);return i&&1===t||s&&0===t}return null});for(var d in n)if(n.hasOwnProperty(d))if(h.forEach(function(e){var t=findObjs({_type:"attribute",_characterid:e.id,name:d})[0];t?t.get("current")&&t.get("current").toString()===n[d]||t.set({current:n[d]}):createObj("attribute",{name:d,current:n[d],characterid:e.id})}),h.length>0)log("changed "+d+" to "+n[d]+" for "+h.length+" creatures"),sendChat("GM",'/w GM changed "'+d+'" to '+n[d].replace("@","&#64;")+" for "+h.length+" creatures");else{var o="no creatures match those parameters";log(o),sendChat("GM","/w GM "+o)}},shaped.importSpell=function(e,t,a){function r(e,t){e.damage&&(setAttribute(n+"spell_toggle_"+t+"_damage","@{spell_var_"+t+"_damage}"),setAttribute(n+"spell_"+t+"_dmg",e.damage)),e.damageBonus&&(setAttribute(n+"spell_toggle_bonuses","@{spell_var_bonuses}"),setAttribute(n+"spell_"+t+"_dmg_bonus",e.damageBonus)),e.castingStat&&setAttribute(n+"spell_"+t+"_dmg_stat","@{casting_stat}"),e.damageType&&setAttribute(n+"spell_"+t+"_dmg_type",e.damageType),e.secondaryDamage&&(setAttribute(n+"spell_toggle_"+t+"_second_damage","@{spell_var_"+t+"_second_damage}"),setAttribute(n+"spell_"+t+"_second_dmg",e.secondaryDamage)),e.secondaryDamageType&&setAttribute(n+"spell_"+t+"_second_dmg_type",e.secondaryDamageType),e.higherLevelDice&&(setAttribute(n+"spell_toggle_higher_lvl_query","@{spell_var_higher_lvl_query}"),setAttribute(n+"spell_toggle_output_higher_lvl_query","@{spell_var_output_higher_lvl_query}"),setAttribute(n+"spell_"+t+"_higher_level_dmg_dice",e.higherLevelDice)),e.higherLevelDie&&setAttribute(n+"spell_"+t+"_higher_level_dmg_die",e.higherLevelDie),e.higherLevelSecondaryDice&&setAttribute(n+"spell_"+t+"_second_higher_level_dmg_dice",e.higherLevelSecondaryDice),e.higherLevelSecondaryDie&&setAttribute(n+"spell_"+t+"_second_higher_level_dmg_die",e.higherLevelSecondaryDie)}log("fifthSpells"),log(fifthSpells),log("fifthSpells.spellsData"),log(fifthSpells.spellsData);var i,s=fifthSpells.spellsData.filter(function(e){return e.name.toLowerCase()===a.toLowerCase()})[0],n="repeating_spellbook";if(!s){var o='Error: cannot find a spell by the name of "'+a+'".';return log(o),void sendChat("GM","/w gm "+o)}if("undefined"==typeof e){var o='Error: cannot find a character by the name of "'+t+'".';return log(o),void sendChat("GM","/w gm "+o)}characterId=e.id,n+=0===s.level?"cantrip_":"level"+s.level+"_";for(var c=0;100>c;c++){var l=findObjs({_type:"attribute",_characterid:characterId,name:n+c+"_spellname"})[0];if(!l){i=c,n+=i+"_";break}}if(setAttribute(n+"spellname",s.name),s.ritual&&setAttribute(n+"spellritual","{{spellritual=1}}"),s.concentration&&setAttribute(n+"spellconcentration","{{spellconcentration=1}}"),s.school&&setAttribute(n+"spellschool",s.school),s.castingTime&&("reaction"===s.castingTime?setAttribute(n+"spell_casting_time","@{spell_casting_time_reaction_var}"):"bonus"===s.castingTime?setAttribute(n+"spell_casting_time","@{spell_casting_time_bonus_var}"):"action"===s.castingTime?setAttribute(n+"spell_casting_time","@{spell_casting_time_action_var}"):"minute"===s.castingTime?setAttribute(n+"spell_casting_time","@{spell_casting_time_minute_var}"):(setAttribute(n+"spell_casting_time","@{spell_casting_time_longer_var}"),setAttribute(n+"spellcasttime",s.castingTime))),s.range&&setAttribute(n+"spellrange",s.range),s.target&&setAttribute(n+"spelltarget",s.target),s.aoe&&setAttribute(n+"spellaoe",s.aoe),s.components&&(s.components.verbal&&setAttribute(n+"spellcomponents_verbal","@{spellcomponents_verbal_var}"),s.components.somatic&&setAttribute(n+"spellcomponents_somatic","@{spellcomponents_somatic_var}"),s.components.material&&setAttribute(n+"spellcomponents_material","@{spellcomponents_material_var}"),s.components.materialMaterial&&setAttribute(n+"spellcomponents",s.components.materialMaterial)),s.duration&&setAttribute(n+"spellduration",s.duration),s.source&&setAttribute(n+"spellsource",s.source),s.description&&setAttribute(n+"spelldescription",s.description),s.higherLevel){setAttribute(n+"spellhighersloteffect",s.higherLevel);var h=!0;(s.attack&&s.attack.higherLevelDice||s.damage&&s.damage.higherLevelDice||s.save&&s.save.higherLevelDice||s.heal&&(s.heal.higherLevelDice||s.heal.higherLevelAmount))&&(h=!1),s.level>0&&h&&setAttribute(n+"spell_toggle_higher_lvl","@{spell_var_higher_lvl}")}if(s.emote){var d,u,g,_,p=getAttrByName(characterId,"gender","current");p&&p.match(/f|female|girl|woman|feminine/gi)?(d="she",u="her",g="her",_="herself"):(d="he",u="him",g="his",_="himself"),s.emote=s.emote.replace("{{GENDER_PRONOUN_HE_SHE}}",d).replace("{{GENDER_PRONOUN_HIM_HER}}",u).replace("{{GENDER_PRONOUN_HIS_HER}}",g).replace("{{GENDER_PRONOUN_HIMSELF_HERSELF}}",_),setAttribute(n+"spellemote",s.emote),setAttribute(n+"spell_toggle_emote","@{spell_var_emote}")}s.attack&&(setAttribute(n+"attackstat","@{casting_stat}"),setAttribute(n+"spell_toggle_attack","@{spell_var_attack}"),r(s.attack,"attack"),s.attack.damage&&setAttribute(n+"spell_toggle_attack_crit","@{spell_var_attack_crit}")),s.damage&&r(s.damage,"attack"),s.save&&(setAttribute(n+"spell_toggle_save","@{spell_var_save}"),s.save.condition&&setAttribute(n+"savecondition",s.save.condition),s.save.ability&&(setAttribute(n+"savestat",capitalizeFirstLetter(s.save.ability.substring(0,3))),setAttribute(n+"spellsavedc","@{casting_stat_dc}")),s.save.saveFailure&&setAttribute(n+"savefailure",s.save.saveFailure),s.save.saveSuccess&&setAttribute(n+"savesuccess",s.save.saveSuccess),r(s.save,"save")),s.heal&&(setAttribute(n+"spell_toggle_healing","@{spell_var_healing}"),setAttribute(n+"spellhealamount",s.heal.amount),s.heal.bonus&&setAttribute(n+"healbonus",s.heal.bonus),s.heal.castingStat&&setAttribute(n+"healstatbonus","@{casting_stat}"),(s.heal.higherLevelDice||s.heal.higherLevelAmount)&&setAttribute(n+"spell_toggle_higher_lvl_query","@{spell_var_higher_lvl_query}"),s.heal.higherLevelDice&&setAttribute(n+"spell_heal_higher_level_dmg_dice",s.heal.higherLevelDice),s.heal.higherLevelDie&&setAttribute(n+"spell_heal_higher_level_dmg_die",s.heal.higherLevelDie),s.heal.higherLevelAmount&&setAttribute(n+"spell_heal_higher_level_amount",s.heal.higherLevelAmount)),s.effects&&(setAttribute(n+"spelleffect",s.effects),setAttribute(n+"spell_toggle_effects","@{spell_var_effects}"));var o=s.name+" imported for "+t+" on spell level "+s.level+" at index "+i;log(o),sendChat("GM","/w gm "+o)},shaped.spellImport=function(e,t){for(var a=t[0].split(", "),r=e.get("represents"),i=findObjs({_type:"character",id:r})[0],s=getAttrByName(r,"character_name","current"),n=0;n<a.length;n++)shaped.importSpell(i,s,a[n])}}("undefined"==typeof shaped?shaped={}:shaped),on("ready",function(){"use strict";shaped.statblock.RegisterHandlers()});