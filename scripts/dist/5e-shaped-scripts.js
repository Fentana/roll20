!function(shaped){function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function HandleInput(e){if(commandExecuter=e.who,shaped.settings.useAmmoAutomatically&&"5eDefault"===e.rolltemplate&&-1!==e.content.indexOf("{{ammo_auto=1}}")){for(var t,a,r,s=/\{\{(.*?)\}\}/gi;r=s.exec(e.content);)if(r[1]){var i=r[1].split("=");"character_name"===i[0]&&(t=i[1]),"ammo_field"===i[0]&&(a=i[1])}shaped.decrementAmmo(t,a)}if("api"===e.type){log("msg.content: "+e.content);var n=e.content.split(/\s+--/);switch(n[0]){case"!build-monster":case"!shaped-parse":case"!shaped-import":n[1]&&"clean"===n[1]&&shaped.getSelectedToken(e,shaped.deleteOldSheet),shaped.getSelectedToken(e,shaped.importStatblock);break;case"!shaped-rollhp":shaped.getSelectedToken(e,shaped.rollTokenHp);break;case"!shaped-settings":n.shift(),shaped.changeSettings(n);break;case"!shaped-spell":n.shift(),shaped.getSelectedToken(e,shaped.spellImport,n);break;case"!shaped-convert":shaped.getSelectedToken(e,shaped.parseOldToNew);break;case"!shaped-token-macro":shaped.getSelectedToken(e,shaped.tokenMacros,n)}}}function messageToChat(e){log(e),sendChat("Shaped","/w gm "+e),commandExecuter&&-1===commandExecuter.indexOf("(GM)")&&sendChat("Shaped","/w "+commandExecuter+" "+e)}function capitalizeEachWord(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}function createInitTokenAction(e){setAbility("Init","","%{"+e+"|Initiative}",shaped.settings.createAbilityAsToken)}function createSaveQueryTokenAction(e){setAbility("Save","","%{"+e+"|save_query_macro}",shaped.settings.createAbilityAsToken)}function createCheckQueryTokenAction(e){setAbility("Check","","%{"+e+"|check_query_macro}",shaped.settings.createAbilityAsToken)}function createSkillQueryTokenAction(e){setAbility("Skill","","%{"+e+"|skill_query_macro}",shaped.settings.createAbilityAsToken)}function setUserDefinedScriptSettings(){shaped.settings.defaultTab&&setAttribute("tab",shaped.settings.defaultTab),"hidden"===shaped.settings.sheetOutput&&setAttribute("output_option","@{output_to_gm}"),shaped.settings.whisperDeathSaves&&setAttribute("death_save_output_option","@{output_to_gm}"),shaped.settings.whisperInitiative&&setAttribute("initiative_output_option","@{output_to_gm}"),shaped.settings.showCharacterNameOnRollTemplate&&setAttribute("show_character_name","@{show_character_name_yes}"),shaped.settings.initiativeTieBreaker&&setAttribute("initiative_tie_breaker","((@{initiative_overall}) / 100)"),shaped.settings.initiativeAddsToTracker&&setAttribute("initiative_to_tracker","@{initiative_to_tracker_yes}"),shaped.settings.attacksVsTargetAC&&setAttribute("attacks_vs_target_ac","@{attacks_vs_target_ac_yes}"),shaped.settings.hideGMInfo&&(setAttribute("hide_save_dc","@{hide_save_dc_var}"),setAttribute("hide_save_failure","@{hide_save_failure_var}"),setAttribute("hide_save_success","@{hide_save_success_var}"),setAttribute("hide_effects","@{hide_effects_var}"),setAttribute("hide_recharge","@{hide_recharge_var}"))}function logObject(e){for(var t in e)e.hasOwnProperty(t)?logObject(e[t]):log("logObj: "+t+"->"+e[t])}function sortNumber(e,t){return e-t}function setAttribute(e,t,a){if(!e)throw"Name required to set attribute";if(a=a||"",!t)return void messageToChat("Error setting empty value: "+e);var r=findObjs({_type:"attribute",_characterid:characterId,name:e})[0];r?r.get("current")&&r.get("current").toString()===t||r.set({current:t,max:a}):createObj("attribute",{name:e,current:t,max:a,characterid:characterId})}function setAbility(e,t,a,r){if(!e)throw"Name required to set ability";var s=findObjs({_type:"ability",_characterid:characterId,name:e});if(!s)throw"Something prevent script to create or find ability "+e;0===s.length?s=createObj("ability",{_characterid:characterId,name:e,description:t,action:a,istokenaction:r}):(s=getObj("ability",s[0].id),(s.get("description")!=t||s.get("action")!==a||s.get("istokenaction")!=r)&&s.set({description:t,action:a,istokenaction:r}))}function clean(e){return unescape(e).replace(/\s\./g,".").replace(/–/g,"-").replace(/<br[^>]*>/g,"#").replace(/\s*#\s*/g,"#").replace(/(<([^>]+)>)/gi,"").replace(/#(?=[a-z]|DC)/g," ").replace(/\s+/g," ").replace(/#Hit:/gi,"Hit:").replace(/Hit:#/gi,"Hit: ").replace(/#Each /gi,"Each ").replace(/#On a successful save/gi,"On a successful save").replace(/DC#(\d+)/g,"DC $1").replace("LanguagesChallenge","Languages -#Challenge").replace("' Speed","Speed").replace(/#Medium or/gi," Medium or").replace(/take#(\d+)/gi,"take $1")}function sanitizeText(e){"string"!=typeof e&&(e=e.toString()),e=e.replace(/\,\./gi,",").replace(/ft\s\./gi,"ft.").replace(/ft\.\s\,/gi,"ft").replace(/ft\./gi,"ft").replace(/(\d+) ft\/(\d+) ft/gi,"$1/$2 ft").replace(/lOd/g,"10d").replace(/dl0/gi,"d10").replace(/dlO/gi,"d10").replace(/dl2/gi,"d12").replace(/Sd(\d+)/gi,"5d$1").replace(/ld(\d+)/gi,"1d$1").replace(/ld\s+(\d+)/gi,"1d$1").replace(/(\d+)d\s+(\d+)/gi,"$1d$2").replace(/(\d+)\s+d(\d+)/gi,"$1d$2").replace(/(\d+)\s+d(\d+)/gi,"$1d$2").replace(/(\d+)d(\d)\s(\d)/gi,"$1d$2$3").replace(/(\d+)j(?:Day|day)/gi,"$1/Day").replace(/(\d+)f(?:Day|day)/gi,"$1/Day").replace(/(\d+)j(\d+)/gi,"$1/$2").replace(/(\d+)f(\d+)/gi,"$1/$2").replace(/{/gi,"(").replace(/}/gi,")").replace(/(\d+)\((\d+) ft/gi,"$1/$2 ft").replace(/• /gi,"").replace(/’/gi,"'"),e=e.replace(/(\d+)\s*?plus\s*?((?:\d+d\d+)|(?:\d+))/gi,"$2 + $1");var t={jday:"/day","abol eth":"aboleth","ACT IONS":"ACTIONS",Afrightened:"A frightened",Alesser:"A lesser","Athl etics":"Athletics",Aundefinedr:"After","blindn ess":"blindness","blind sight":"blindsight",bofh:"both","brea stplate":"breastplate","choos in g":"choosing","com muni cate":"communicate","Constituti on":"Constitution","creatu re":"creature","darkvi sion":"darkvision","dea ls":"deals","di sease":"disease","di stance":"distance","fa lls":"falls","fe et":"feet","exha les":"exhales","ex istence":"existence",lfthe:"If the",Ifthe:"If the",lnt:"Int","magica lly":"magically",minlilte:"minute","natura l":"natural",ofeach:"of each",ofthe:"of the","on'e":"one","0n":"on","pass ive":"passive","Perce ption":"Perception","radi us":"radius","ra nge":"range","rega ins":"regains","rest.oration":"restoration","savin g":"saving","si lvery":"silvery","s lashing":"slashing","slas hing":"slashing","slash in g":"slashing","slash ing":"slashing","Spel/casting":"Spellcasting","successfu l":"successful","ta rget":"target"," Th e ":" The ",t_urns:"turns","unti l":"until","withi n":"within"},a=new RegExp(Object.keys(t).join("|"),"gi");return e=e.replace(a,function(e){return t[e]})}function findKeyword(e){for(var t={attr:{},traits:{},actions:{},lair:{},legendary:{},reactions:{}},a=0,r=e.length,s=e.length,i=e.length,n=/#\s*(tiny|small|medium|large|huge|gargantuan|armor class|hit points|speed|str|dex|con|int|wis|cha|saving throws|skills|damage resistances|damage immunities|condition immunities|damage vulnerabilities|senses|languages|challenge|traits|actions|lair actions|legendary actions|reactions)(?=\s|#)/gi;match=n.exec(e);){var o=match[1].toLowerCase();"actions"===o?(a=match.index,t.actions.Actions=match.index):"legendary actions"===o?(s=match.index,t.legendary.Legendary=match.index):"reactions"===o?(i=match.index,t.reactions.Reactions=match.index):"lair actions"===o?(r=match.index,t.lair.Lair=match.index):t.attr[o]=match.index}for(n=/(?:#)([A-Z][\w-\']+(?:\s(?:[A-Z][\w-\']+|[\(\)\/\d\-]|of|and|or|a)+)*)(?=\s*\.)/gi,log("parsed statblock: "+e);match=n.exec(e);)t.attr[match[1].toLowerCase()]||(match.index<a?t.traits[match[1]]=match.index:match.index>a&&match.index<s&&match.index<i&&match.index<r?t.actions[match[1]]=match.index:match.index>s&&match.index<i&&match.index<r?t.legendary[match[1]]=match.index:match.index>i&&match.index<r?t.reactions[match[1]]=match.index:match.index>r&&(t.lair[match[1]]=match.index));var c=e.split("#"),l="",h=[],d=1;for(var u in t.actions)t.actions.hasOwnProperty(u)&&h.push(t.actions[u]);for(var g in t.legendary)t.legendary.hasOwnProperty(g)&&h.push(t.legendary[g]);for(var _ in t.lair)t.lair.hasOwnProperty(_)&&h.push(t.lair[_]);h.sort(sortNumber);for(var p,m=h[h.length-1]+1;6>d;)l=c[c.length-d],p=e.indexOf(l),p>m&&(t.traits.Description=p-1),d++;return t}function splitStatblock(e,t){var a=[];for(var r in t)if(t.hasOwnProperty(r)){var s=t[r];for(var i in s)s.hasOwnProperty(i)&&a.push(s[i])}a.sort(sortNumber),t.attr.name=extractSection(e.substring(0,a[0]),"name");for(var r in t)if(t.hasOwnProperty(r)){var s=t[r];for(var i in s)if(s.hasOwnProperty(i)){var n=s[i],o=a.indexOf(n)+1,c=a[o]||e.length;t[r][i]=extractSection(e.substring(n,c),i)}}delete t.actions.Actions,delete t.legendary.Legendary,delete t.reactions.Reactions;for(var l=["str","dex","con","int","wis","cha"],h="",d=0,u=l.length;u>d;++d)t.attr.hasOwnProperty([l[d]])&&(h+=t.attr[l[d]]+" ",delete t.attr[l[d]]);t.attr.abilities=h;var g=["tiny","small","medium","large","huge","gargantuan"];for(d=0,u=g.length;u>d;++d)if(t.attr.hasOwnProperty([g[d]])){t.attr.size=g[d]+" "+t.attr[g[d]],delete t.attr[g[d]];break}return t}function extractSection(e,t){return e.replace(new RegExp("^[\\s\\.#]*"+t.replace(/([-()\\/])/g,"\\$1")+"?[\\s\\.#]*","i"),"").replace(/#/g," ")}function processSection(e){e.attr.abilities&&parseAbilities(e.attr.abilities),e.attr.size&&parseSize(e.attr.size),e.attr["armor class"]&&parseArmorClass(e.attr["armor class"]),e.attr["hit points"]&&parseHp(e.attr["hit points"]),e.attr.speed&&parseSpeed(e.attr.speed),e.attr.challenge&&parseChallenge(e.attr.challenge),e.attr["saving throws"]&&parseSavingThrow(e.attr["saving throws"]),e.attr.skills&&parseSkills(e.attr.skills),e.attr.senses&&parseSenses(e.attr.senses),e.attr["damage immunities"]&&setAttribute("damage_immunity",e.attr["damage immunities"]),e.attr["condition immunities"]&&setAttribute("condition_immunity",e.attr["condition immunities"]),e.attr["damage vulnerabilities"]&&setAttribute("damage_vulnerability",e.attr["damage vulnerabilities"]),e.attr["damage resistances"]&&setAttribute("damage_resistance",e.attr["damage resistances"]),e.attr.languages&&setAttribute("prolanguages",e.attr.languages),parseTraits(e.traits),parseReactions(e.reactions),parseActions(e.actions),parseActions(e.legendary,"legendary_"),parseActions(e.lair,"lair_")}function parseAbilities(e){for(var t=/(\d+)\s*\(/g,a=[];matches=t.exec(e);)a.push(matches[1]);setAttribute("strength",a[0]),setAttribute("dexterity",a[1]),setAttribute("constitution",a[2]),setAttribute("intelligence",a[3]),setAttribute("wisdom",a[4]),setAttribute("charisma",a[5])}function parseSize(e){var t=e.match(/(.*?) (.*?), (.*)/i);if(!(t&&t[1]&&t[2]&&t[3]))throw"Character doesn't have valid type/size/alignment format";setAttribute("size",capitalizeEachWord(t[1])),setAttribute("npc_type",capitalizeEachWord(t[2])),setAttribute("alignment",capitalizeEachWord(t[3]))}function parseArmorClass(e){var t=e.match(/(\d+)\s?(.*)/);if(!t||!t[1])throw"Character doesn't have valid AC format";setAttribute("npc_AC",t[1]),t[2]&&setAttribute("npc_AC_note",t[2].replace(/\(|\)/g,""))}function parseHD(e){for(var t,a=/(\d+)d(\d+)/gi;t=a.exec(e);){if(!t||!t[1]||!t[2])throw"Character doesn't have valid hd format";var r=t[1],s="d"+t[2];setAttribute("hd_"+s,r,r),setAttribute("hd_"+s+"_toggle","on")}}function parseHp(e){var t=e.match(/(\d+)\s?\(([\dd\s\+\-]*)\)/i);if(!t||!t[1]||!t[2])throw"Character doesn't have valid HP/HD format";setAttribute("HP",t[1],t[1]),setAttribute("npc_HP_hit_dice",t[2]),parseHD(t[2])}function parseSpeed(e){for(var t="speed",a=/(|burrow|climb|fly|swim|)\s*(\d+)\s*?(?:ft)?\s*(\(.*\))?/gi;match=a.exec(e);){if(!match[2])throw"Character doesn't have valid speed format";var r=t+(""!==match[1]?"_"+match[1].toLowerCase():""),s=match[2];match[3]&&match[3].indexOf("hover")&&setAttribute("speed_fly_hover","on"),setAttribute(r,s)}}function parseSenses(e){e=e.replace(/[,\s]*passive.*/i,"");for(var t=/(|blindsight|darkvision|tremorsense|truesight|)\s*?(\d+)\s*?ft?\s*(\(.*\))?/gi;match=t.exec(e);){if(!match||!match[1]||!match[2])throw"Character doesn't have valid senses format";var a=match[1].toLowerCase(),r=match[2];match[3]&&match[3].indexOf("blind beyond")&&setAttribute("blindsight_blind_beyond","on"),setAttribute(a,r)}}function setTokenVision(e){var t,a,r=parseInt(getAttrByName(characterId,"blindsight"),10)||0,s=parseInt(getAttrByName(characterId,"darkvision"),10)||0,i=parseInt(getAttrByName(characterId,"tremorsense"),10)||0,n=parseInt(getAttrByName(characterId,"truesight"),10)||0,o=Math.max(r,s,i,n),c=Math.max(r,i,n);o===r?(t=r,a=r):o===i?(t=i,a=i):o===n?(t=n,a=n):o===s&&(t=Math.ceil(1.1666666*s),a=c>0?c:-5),t>0&&e.set("light_radius",t),a&&e.set("light_dimradius",a),e.set("light_hassight",!0),e.set("light_angle",360),e.set("light_losangle",360)}function parseChallenge(e){var t=e.replace(/[, ]/g,""),a=t.match(/([\d/]+).*?(\d+)/);setAttribute("challenge",a[1]);var r=parseInt(a[2]);getAttrByName(characterId,"xp")!==r&&setAttribute("xp",r)}function parseSavingThrow(save){for(var regex=/(STR|DEX|CON|INT|WIS|CHA).*?(\d+)/gi,attr;match=regex.exec(save);){switch(match[1].toLowerCase()){case"str":attr="strength";break;case"dex":attr="dexterity";break;case"con":attr="constitution";break;case"int":attr="intelligence";break;case"wis":attr="wisdom";break;case"cha":attr="charisma"}setAttribute(attr+"_save_prof","@{PB}");var proficiencyBonus=2+Math.floor(Math.abs((eval(getAttrByName(characterId,"challenge"))-1)/4)),totalSaveBonus=match[2]-proficiencyBonus-Math.floor((getAttrByName(characterId,attr)-10)/2);0!==totalSaveBonus&&setAttribute(attr+"_save_bonus",totalSaveBonus)}}function parseSkills(skills){for(var skillAbility={acrobatics:"dexterity","animal handling":"wisdom",arcana:"intelligence",athletics:"strength",deception:"charisma",history:"intelligence",insight:"wisdom",intimidation:"charisma",investigation:"intelligence",medicine:"wisdom",nature:"intelligence",perception:"wisdom",performance:"charisma",persuasion:"charisma",religion:"intelligence","sleight of hand":"dexterity",stealth:"dexterity",survival:"wisdom"},extraSkillAbility={"alchemist's supplies":"intelligence","navigator's tools":"wisdom","thieves' tools":"dexterity"},regex=/([\w\s\']+).*?(\d+)/gi,customSkillNum=0;match=regex.exec(skills.replace(/Skills\s+/i,""));){var skill=match[1].trim().toLowerCase(),proficiencyBonus=2+Math.floor(Math.abs((eval(getAttrByName(characterId,"challenge"))-1)/4)),expertise=2*proficiencyBonus;if(skill in skillAbility){var abilitymod=skillAbility[skill],attr=skill.replace(/\s/g,""),totalSkillBonus=match[2]-Math.floor((getAttrByName(characterId,abilitymod)-10)/2);totalSkillBonus>=expertise?(setAttribute(attr+"_prof_exp","@{exp}"),totalSkillBonus>expertise&&setAttribute(attr+"_bonus",totalSkillBonus-expertise)):totalSkillBonus>=proficiencyBonus?(setAttribute(attr+"_prof_exp","@{PB}"),totalSkillBonus>proficiencyBonus&&setAttribute(attr+"_bonus",totalSkillBonus-proficiencyBonus)):(setAttribute(attr+"_prof_exp","@{jack_of_all_trades}"),totalSkillBonus>0&&setAttribute(attr+"_bonus",totalSkillBonus))}else if(skill in extraSkillAbility){customSkillNum++;var abilitymod=extraSkillAbility[skill],attr="custom_skill_"+customSkillNum,totalSkillBonus=match[2]-Math.floor((getAttrByName(characterId,abilitymod)-10)/2);setAttribute(attr+"_name",capitalizeEachWord(skill)),log("added "+capitalizeEachWord(skill)+" to custom skills"),totalSkillBonus>=expertise?(setAttribute(attr+"_prof_exp","@{exp}"),totalSkillBonus>expertise&&setAttribute(attr+"_bonus",totalSkillBonus-expertise)):totalSkillBonus>=proficiencyBonus?(setAttribute(attr+"_prof_exp","@{PB}"),totalSkillBonus>proficiencyBonus&&setAttribute(attr+"_bonus",totalSkillBonus-proficiencyBonus)):(setAttribute(attr+"_prof_exp","@{jack_of_all_trades}"),totalSkillBonus>0&&setAttribute(attr+"_bonus",totalSkillBonus))}else errors.push("Skill "+skill+" is not a valid skill");customSkillNum>0&&setAttribute("custom_skills_toggle","on")}}function parseTraits(e){var t=[];if(_.each(e,function(e,a){t.push("**"+a+"**. "+e)}),t.length>0){var a=t.join("\n");setAttribute("npc_traits",a)}}function parseReactions(e){var t=[];_.each(e,function(e,a){t.push("**"+a+"**. "+e)}),t.length>0&&(setAttribute("reactions",t.join("\n")),setAttribute("toggle_reactions","on"))}function parseActions(e,t){function a(e){function a(e,a,r){"undefined"==typeof r&&(r=a),r&&setAttribute("repeating_"+t+"actions_"+N+"_"+e,a.trim())}function r(e,a){("undefined"==typeof a||a)&&setAttribute("repeating_"+t+"actions_"+N+"_toggle_"+e,"@{repeating_"+t+"actions_"+N+"_var_"+e+"}")}function s(e){return e.replace(/\s?[\+\-]\s?\d+/g,"")}function n(e){a("name",e)}function o(e){a("type",e)}function c(e){a("target",e),r("target")}function l(e){a("range",e),r("range")}function h(e,t){a(t+"dmg",e)}function d(e){r(e+"damage")}function u(e,t){a(t+"dmg_type",e)}function g(e,t){a(t+"crit_dmg",e)}function p(e){a("alt_dmg_reason",e)}function m(e){e&&a("effect",e.replace(/(\s*?Hit:\s?)/gi,"").replace(/(\d+)d(\d+)/g,"[[$1d$2]]").replace(/\s(\d+)\s/g," [[$1]] ")),r("effects",e)}function v(e){a("save_dc",e)}function f(e){e&&a("save_stat",e.substring(0,3))}function b(e){r("save",e)}function A(e){r("save_damage",e)}function y(e){a("save_dmg",e)}function k(e){a("save_dmg_type",e)}function C(e){a("save_success",e)}function x(e){m(e)}function w(e,t){e&&(e[1]&&(e[2]=e[1]),e[2]&&(h(e[2],t),g(s(e[2]),t)),e[4]&&(e[3]+=" "+e[4]),e[3]&&u(e[3],t),(e[2]||e[3])&&d(t),e[5]&&m(e[5].trim()),e[6]&&p(e[6]))}var N=0,P=[],S=/\,?\.?\s*?/,T=/\,?\.?\s*/,O=/\,?\.?\s?/,B=/Hit:.*?/,I=/((?:[\w]+|[\w]+\s(?:or|and)\s[\w]+)(?:\s*?\([\w\s]+\))?)\s*?damage\s?(\([\w\'\s]+\))?/,F=/(?:(\d+)|.*?\(([\dd\s\+\-]*)\).*?)\s*?/,D=/(?:\,\s*?or\s*?)/,E=/((?:if|in)[\w\s]+)/,L=/(The.*|If the.*)?/,H=/\s*?plus\s*?/,R=/(?:DC)\s*?(\d+)\s*?([a-zA-Z]*)\s*?(?:saving throw)/,j=/\,?\s*?(?:taking|or take)/,M=/(?: against disease)?/,$=/(?:.*or\s(.*)?\son a successful one.)?/,z=/(?:On a successful save,)?(.*)?/,Q=/(?:On a (?:failure|failed save))\,\s(?:(.*). On a success,\s(.*)?)?(.*)?/,q=/(\s?and.*)?/,U=/(or\s(?!take).*)/,W=/(.*)?/,V=new RegExp(B.source+F.source+I.source+S.source+q.source,"i"),G=new RegExp(H.source+F.source+I.source+S.source+W.source,"i"),Z=new RegExp(D.source+F.source+I.source+S.source+E.source+O.source+L.source,"i"),K=new RegExp(B.source+W.source,"i"),J=new RegExp(R.source+j.source+F.source+I.source+$.source+S.source+W.source+z.source,"i"),X=new RegExp(R.source+M.source+T.source+U.source,"i"),Y=new RegExp(R.source+S.source+Q.source,"i");_.each(e,function(e,s){function h(){setAbility(s,"","%{"+characterName+"|repeating_"+t+"actions_"+N+"_action}",shaped.settings.createAbilityAsToken)}var d,u=!1,g=!1,_=!1,p=s.indexOf("(");p>1?i[N]=s.substring(0,p-1).toLowerCase():i[N]=s.toLowerCase();for(var S=/\s*?\((?:Recharge\s*?(\d+\-\d+|\d+)|Recharges\safter\sa\s(.*))\)/gi;keyResult=S.exec(s);){var T=keyResult[1]||keyResult[2];a("recharge",T),r("recharge"),T&&(s=s.replace(S,""))}for(var O=/\s*?\((\d+\/Day)\)/gi;rechargeDayResult=O.exec(s);){var T=rechargeDayResult[1]||rechargeDayResult[2];a("recharge",T),r("recharge"),T&&(s=s.replace(O,""))}n(s);for(var B=e.split(/\.(.+)?/),I=B[0],F=I.split(","),D=/(melee|ranged|melee or ranged)\s*(spell|weapon)\s*/gi;type=D.exec(F[0]);){if(type[1]){var E="Melee or Ranged";type[1].toLowerCase()===E.toLowerCase()&&(type[1]="Thrown"),o(capitalizeEachWord(type[1]))}if(type[2]){capitalizeEachWord(type[2])}u=!0}for(var L=/\+\s?(\d+)\s*(?:to hit)/gi;toHit=L.exec(F[0]);)toHit[1]&&(a("tohit",toHit[1]),r("attack"),r("crit")),F[2]&&c(F[2].trim().toLowerCase()),u=!0;for(var H=/(?:reach)\s?(\d+)\s?(?:ft)/gi;reach=H.exec(F[1]);)reach[1]&&(a("reach",reach[1]+" ft",reach[1]),r("reach")),u=!0;for(var R=/(?:range)\s?(\d+)\/(\d+)\s?(ft)/gi;range=R.exec(F[1]);)range[1]&&range[2]&&l(range[1]+"/"+range[2]+" ft"),u=!0;var j=V.exec(e);if(j)w(j,"");else{var M=K.exec(e);M&&M[1]&&m(M[1].trim())}var $=G.exec(e);$&&w($,"second_");var z=Z.exec(e);z&&(z[6]=[z[5],z[5]=z[6]][0],w(z,"alt_"));var j=V.exec(e);Q&&w(j,"");var Q=J.exec(e);Q&&(Q[1]&&v(Q[1]),Q[2]&&f(Q[2]),Q[3]&&(Q[4]=Q[3]),Q[4]&&y(Q[4]),Q[6]&&(Q[5]+=" "+Q[6]),Q[5]&&k(Q[5]),Q[9]&&(Q[7]=Q[9]),Q[7]&&C(Q[7]),Q[8]&&x(Q[8]),(Q[1]||Q[2]||Q[8])&&b(),(Q[4]||Q[5]||Q[7])&&A(),g=!0);var q=X.exec(e);q&&(q[1]&&v(q[1]),q[2]&&f(q[2]),q[3]&&x(q[3]),(q[1]||q[2]||q[3])&&b(),g=!0);var U=Y.exec(e);U&&(U[1]&&v(U[1]),U[2]&&f(U[2]),U[5]&&(U[3]=U[5]),U[3]&&x(U[3]),U[4]&&C(U[4]),(U[1]||U[2]||U[3]||U[4])&&b(),g=!0);for(var W=/((?:Each | a | an | one ).*(?:creature|target).*)\s(?:within|in)\s*?a?\s*?(\d+)\s*?(?:feet|ft)/gi;saveRange=W.exec(e);)saveRange[1]&&c(saveRange[1].trim()),saveRange[2]&&l(saveRange[2]+" ft",saveRange[2]);var ee=/(\d+)\-foot line\s*?that is (\d+) feet wide/gi,te=ee.exec(e),ae=/line that is (\d+)\sfeet long\s*?and (\d+) feet wide/gi,re=ae.exec(e),se=te||re;se&&(o("Line"),se[1]&&se[2]?l(se[1]+"-foot line that is "+se[2]+" feet wide"):se[1]&&l(se[1]));for(var ie=/\.\s*(.*in that line)/gi;lineTarget=ie.exec(e);)c(lineTarget[1]);d=u||_||g,d?("legendary_"===t&&P.push(s+". See below"),s.indexOf("Costs ")>0&&(s=s.replace(/\s*\(Costs\s*\d+\s*Actions\)/gi,""),n(s)),h(),N++):"legendary_"===t?P.push(s+". "+e):(m(e),h(),N++)}),P.length>0&&setAttribute("legendary_action_notes",P.join("\n"))}function r(e){""!==d&&(d+="\n"),d+="%{"+characterName+"|repeating_actions_"+e+"_action}"}t||(t="");var s,i=[];shaped.settings.addInitiativeTokenAbility&&createInitTokenAction(characterName),shaped.settings.addSaveQueryMacroTokenAbility&&createSaveQueryTokenAction(characterName),shaped.settings.addCheckQueryMacroTokenAbility&&createCheckQueryTokenAction(characterName),shaped.settings.addSkillQueryMacroTokenAbility&&createSkillQueryTokenAction(characterName);for(var n in e){var o=/Multiattack(?:\s*(\(.*\)))?/gi,c=o.exec(n),s="";if(c){c[1]&&(s=c[1]+": "),s+=e[n],setAttribute("multiattack",s),delete e[n],setAttribute("toggle_multiattack","on"),setAbility("MultiAtk","","%{"+characterName+"|multiattack}",shaped.settings.createAbilityAsToken);break}}if(a(e),"lair_"===t&&Object.keys(e).length>0&&setAttribute("toggle_lair_actions","on"),"legendary_"===t&&Object.keys(e).length>0&&setAttribute("toggle_legendary_actions","on"),s){for(var l,h=i.join("|"),o=new RegExp("(one|two|three)? (?:with its )?("+h+")( or)?","gi"),d="";match=o.exec(s);){var u=match[2],g=match[1]||"one";l=i.indexOf(u.toLowerCase()),-1!==l&&(r(l),"two"==g&&r(l),"three"==g&&r(l),match[3]&&(d+="or\n"),delete i[l])}setAttribute("multiattack_script",d)}}function parseActionsForConvert(){for(var e={},t={},a={},r=[],s=1;20>=s;s++){var i=getAttrByName(characterId,"npc_action_name"+s,"current"),n=getAttrByName(characterId,"npc_action_type"+s,"current"),o=getAttrByName(characterId,"npc_action_description"+s,"current"),c=getAttrByName(characterId,"npc_action_effect"+s,"current"),l=o+" "+c;i&&(l=l.replace(/\s*?\:\s*?\[\[(\d+d\d+[\d\s+|\-]*)\]\]\s*?\|\s*?\[\[(\d+d\d+[\d\s+|\-]*)\]\]/gi,"").replace(/\[\[(\d*d\d+[\d\s+|\-]*)\]\]/gi,"$1"),1===n.indexOf("Bonus Action")?(log("Bonus Action "+i+" changed to a normal action"),e[i]=l):1===n.indexOf("Legendary Action")?(log("Legendary Action "+i),a[i]=l):1===n.indexOf("Reaction")?(log("Reaction "+i),r.push(l)):1===n.indexOf("Lair Action")?(log("Lair Action "+i),t[i]=l):1===n.indexOf("Special Action")?(log("Special Action "+i+" changed to a normal action"),e[i]=l):(log("Action "+i),e[i]=l))}Object.keys(e).length>0&&parseActions(e),Object.keys(a).length>0&&parseActions(a,"legendary_"),r.length>0&&(setAttribute("reactions",r.join("\n")),setAttribute("toggle_reactions","on")),Object.keys(t).length>0&&parseActions(t,"lair_")}function convertAttrFromNPCtoPC(e,t){var a=getAttrByName(characterId,e),r=getAttrByName(characterId,t);a&&!r&&(log("convert from "+e+" to "+t),a=sanitizeText(a),setAttribute(t,a))}function clearBar(e,t){e.set(t+"_link",""),e.set(t+"_value",""),e.set(t+"_max","")}function setBarValueAfterConvert(e){for(var t=0;3>t;t++){var a=shaped.settings.bar[t].name,r="bar"+(t+1);if(""!==a){var s,i,n,o=findObjs({name:a,_type:"attribute",_characterid:characterId},{caseInsensitive:!0})[0];o?(s=o.id,i=o.attributes.current,n=o.attributes.max):s="sheetattr_"+a,shaped.settings.bar[t].link?e.set(r+"_link",s):e.get(r+"_link")&&(log(r+": link isn't set in the bar settings, clearing link"),e.set(r+"_link","")),a?e.set(r+"_value",i):e.get(r+"_value")&&(log(r+": current isn't set in the bar settings, clearing current"),e.set(r+"_value","")),shaped.settings.bar[t].max?e.set(r+"_max",n):e.get(r+"_max")&&(log(r+": max isn't set in the bar settings, clearing max"),e.set(r+"_max",""))}else log(r+": no defined bar setting in shaped-scripts (at the top of the page), clearing "+r+"."),clearBar(e,r)}}shaped.settings={createAbilityAsToken:!0,rollMonsterHpOnDrop:!0,showName:!0,showNameToPlayers:!1,showCharacterNameOnRollTemplate:!1,sheetOutput:"",whisperDeathSaves:!0,initiativeTieBreaker:!0,whisperInitiative:!0,initiativeAddsToTracker:!0,addInitiativeTokenAbility:!0,attacksVsTargetAC:!1,attacksVsTargetName:!1,addSaveQueryMacroTokenAbility:!0,addCheckQueryMacroTokenAbility:!0,addSkillQueryMacroTokenAbility:!0,useAmmoAutomatically:!0,bar:[{name:"npc_AC",max:!1,link:!0,show:!1},{name:"",max:!1,link:!1,show:!1},{name:"HP",max:!0,link:!1,show:!1}]},shaped.statblock={version:"1.98",RegisterHandlers:function(){on("chat:message",HandleInput),shaped.settings.rollMonsterHpOnDrop&&on("add:graphic",function(e){shaped.rollTokenHp(e)}),log("Shaped Scripts ready")}};var status="",errors=[],obj=null,characterId=null,characterName=null,commandExecuter=null;shaped.getSelectedToken=shaped.getSelectedToken||function(e,t){try{if(!e.selected||!e.selected.length)throw"No token selected";for(var a=0;a<e.selected.length;a++)if("graphic"===e.selected[a]._type){var r=getObj("graphic",e.selected[a]._id);r&&"token"===r.get("subtype")&&t(r,arguments[2])}}catch(s){messageToChat("Exception: "+s)}},shaped.deleteOldSheet=function(e){var t=e.get("represents"),a=findObjs({_type:"character",id:t})[0];a&&(a.remove(),log("old sheet removed before importing"))},shaped.tokenMacros=function(e,t){var a=e.get("represents"),r=findObjs({_type:"character",id:a})[0],s=getAttrByName(a,"character_name","current");return"undefined"==typeof r?void messageToChat('Error: cannot find a character by the name of "'+s+'".'):(characterId=r.id,void("init"===t[1]?(createInitTokenAction(s),messageToChat("created init token macro for "+s+".")):"query"===t[1]?(createSaveQueryTokenAction(s),createCheckQueryTokenAction(s),createSkillQueryTokenAction(s),messageToChat("created query token macros for "+s+".")):"bootstrap"===t[1]&&(createInitTokenAction(s),createSaveQueryTokenAction(s),createCheckQueryTokenAction(s),createSkillQueryTokenAction(s),messageToChat("bootstraped all token macros for "+s+"."))))},shaped.decrementAmmo=function(e,t){var a=findObjs({_type:"character",name:e})[0],r=findObjs({_type:"attribute",_characterid:a.id,name:t})[0],s=parseInt(r.get("current"),10)||0;r.set({current:s-1})},shaped.rollTokenHp=function(e){for(var t,a=0;3>a;a++)if("HP"===shaped.settings.bar[a].name){t=a+1;break}if(!t)return void messageToChat('One of the bar names has to be set to "HP" for random HP roll');var r="bar"+t,s=e.get("represents");if(""===s)messageToChat("Token does not represent a character");else if(""!==e.get(r+"_link"))messageToChat("Token "+r+" is linked");else{var i=getAttrByName(s,"is_npc","current");if(1===i||"1"===i){for(var n=[4,6,8,10,12,20],o="",c=0,l=0,a=0;a<n.length;a++){var h=parseInt(getAttrByName(s,"hd_d"+n[a],"current"),10);h&&(""!==o&&(o+=" + "),c+=h,o+=h+"d"+n[a],l+=(n[a]/2+.5)*h)}var d=c*Math.floor((getAttrByName(s,"constitution","current")-10)/2);o+=" + "+d,l+=d,l=Math.floor(l),sendChat("Shaped","/roll "+o,function(t){var a=JSON.parse(t[0].content);_.has(a,"total")&&(e.set(r+"_value",a.total),e.set(r+"_max",a.total),messageToChat("HP ("+o+") | average: "+l+" | rolled: "+a.total))})}}log("Still working after trying to roll hp")},shaped.setCharacter=function(e,t){if(!characterName)throw"Name require to get or create character";var a=findObjs({_type:"character",name:characterName});if(0===a.length?(a=createObj("character",{name:characterName,avatar:e.get("imgsrc")}),status=characterName+" created"):(a=getObj("character",a[0].id),status=characterName+" updated"),!a)throw"Something prevent script to create or find character "+characterName;return t&&a.set({gmnotes:t}),characterId=a.id,1!==getAttrByName(characterId,"is_npc")&&setAttribute("is_npc",1),a},shaped.importStatblock=function(e){status="Nothing modified",errors=[];var t=e.get("gmnotes").trim();if(""===t)throw"Selected token GM Notes was empty.";if(shaped.parseStatblock(e,t),characterId){e.set("represents",characterId);var a=characterName;shaped.settings.useAaronsNumberedScript&&1!==characterName.indexOf("%%NUMBERED%%")&&(a+=" %%NUMBERED%%"),e.set("name",a),shaped.settings.showName&&e.set("showname",!0),shaped.settings.showNameToPlayers&&e.set("showplayers_name",!0),setUserDefinedScriptSettings(),setBarValueAfterConvert(e),shaped.settings.bar[0].show&&e.set("showplayers_bar1","true"),shaped.settings.bar[1].show&&e.set("showplayers_bar2","true"),shaped.settings.bar[2].show&&e.set("showplayers_bar3","true"),setTokenVision(e)}messageToChat(status),errors.length>0&&messageToChat("Error(s): "+errors.join("\n/w GM "))},shaped.parseStatblock=function(e,t){log("---- Parsing statblock ----");var a=sanitizeText(clean(t)),r=findKeyword(a),s=splitStatblock(a,r);characterName=capitalizeEachWord(s.attr.name.toLowerCase()),shaped.setCharacter(e,a.replace(/#/g,"<br>")),processSection(s)},shaped.parseOldToNew=function(e){log("---- Parsing old attributes to new ----"),characterId=e.attributes.represents,convertAttrFromNPCtoPC("npc_initiative","initiative"),convertAttrFromNPCtoPC("npc_initiative_overall","initiative_overall"),convertAttrFromNPCtoPC("npc_strength","strength"),convertAttrFromNPCtoPC("npc_strength_save_bonus","strength_save_bonus"),convertAttrFromNPCtoPC("npc_basic_strength_bonus","basic_strength_bonus"),convertAttrFromNPCtoPC("npc_dexterity","dexterity"),convertAttrFromNPCtoPC("npc_dexterity_save_bonus","dexterity_save_bonus"),convertAttrFromNPCtoPC("npc_basic_dexterity_bonus","basic_dexterity_bonus"),convertAttrFromNPCtoPC("npc_constitution","constitution"),convertAttrFromNPCtoPC("npc_constitution_save_bonus","constitution_save_bonus"),convertAttrFromNPCtoPC("npc_basic_constitution_bonus","basic_constitution_bonus"),convertAttrFromNPCtoPC("npc_intelligence","intelligence"),convertAttrFromNPCtoPC("npc_intelligence_save_bonus","intelligence_save_bonus"),convertAttrFromNPCtoPC("npc_basic_intelligence_bonus","basic_intelligence_bonus"),convertAttrFromNPCtoPC("npc_wisdom","wisdom"),convertAttrFromNPCtoPC("npc_wisdom_save_bonus","wisdom_save_bonus"),convertAttrFromNPCtoPC("npc_basic_wisdom_bonus","basic_wisdom_bonus"),convertAttrFromNPCtoPC("npc_charisma","charisma"),convertAttrFromNPCtoPC("npc_charisma_save_bonus","charisma_save_bonus"),convertAttrFromNPCtoPC("npc_basic_charisma_bonus","basic_charisma_bonus"),convertAttrFromNPCtoPC("npc_alignment","alignment");var t=getAttrByName(characterId,"npc_HP"),a=getAttrByName(characterId,"HP"),r=getAttrByName(characterId,"npc_HP","max"),s=getAttrByName(characterId,"HP","max");t&&!a&&r&&!s?setAttribute("HP",t,r):t&&!a?setAttribute("HP",t):r&&!s&&setAttribute("HP",0,r),convertAttrFromNPCtoPC("npc_temp_HP","temp_HP");var i=getAttrByName(characterId,"npc_HP_hit_dice");i&&parseHD(i);var n=[],o=getAttrByName(characterId,"npc_speed"),c=getAttrByName(characterId,"npc_speed_fly"),l=getAttrByName(characterId,"npc_speed_climb"),h=getAttrByName(characterId,"npc_speed_swim");o&&(1!==o.indexOf("ft")&&(o+=" ft"),n.push(o)),c&&(1!==c.indexOf("ft")&&(c+=" ft"),n.push("fly "+c)),l&&(1!==l.indexOf("ft")&&(l+=" ft"),n.push("climb"+l)),h&&(1!==h.indexOf("ft")&&(h+=" ft"),n.push("swim"+h)),parseSpeed(n.join(", ")),convertAttrFromNPCtoPC("npc_xp","xp"),convertAttrFromNPCtoPC("npc_challenge","challenge"),convertAttrFromNPCtoPC("npc_size","size"),parseSenses(sanitizeText(getAttrByName(characterId,"npc_senses"))),convertAttrFromNPCtoPC("npc_languages","prolanguages"),convertAttrFromNPCtoPC("npc_damage_resistance","damage_resistance"),
convertAttrFromNPCtoPC("npc_damage_vulnerability","damage_vulnerability"),convertAttrFromNPCtoPC("npc_damage_immunity","damage_immunity"),convertAttrFromNPCtoPC("npc_condition_immunity","condition_immunity"),convertAttrFromNPCtoPC("npc_acrobatics_bonus","acrobatics_bonus"),convertAttrFromNPCtoPC("npc_animalhandling_bonus","animalhandling_bonus"),convertAttrFromNPCtoPC("npc_arcana_bonus","arcana_bonus"),convertAttrFromNPCtoPC("npc_athletics_bonus","athletics_bonus"),convertAttrFromNPCtoPC("npc_deception_bonus","deception_bonus"),convertAttrFromNPCtoPC("npc_history_bonus","history_bonus"),convertAttrFromNPCtoPC("npc_insight_bonus","insight_bonus"),convertAttrFromNPCtoPC("npc_intimidation_bonus","intimidation_bonus"),convertAttrFromNPCtoPC("npc_investigation_bonus","investigation_bonus"),convertAttrFromNPCtoPC("npc_medicine_bonus","medicine_bonus"),convertAttrFromNPCtoPC("npc_nature_bonus","nature_bonus"),convertAttrFromNPCtoPC("npc_perception_bonus","perception_bonus"),convertAttrFromNPCtoPC("npc_performance_bonus","performance_bonus"),convertAttrFromNPCtoPC("npc_persuasion_bonus","persuasion_bonus"),convertAttrFromNPCtoPC("npc_religion_bonus","religion_bonus"),convertAttrFromNPCtoPC("npc_sleightofhand_bonus","sleightofhand_bonus"),convertAttrFromNPCtoPC("npc_stealth_bonus","stealth_bonus"),convertAttrFromNPCtoPC("npc_survival_bonus","survival_bonus"),setUserDefinedScriptSettings(),parseActionsForConvert(),shaped.setBars(e),setTokenVision(e),shaped.settings.showName&&e.set("showname",!0),messageToChat("Character "+e.attributes.name+" converted")},shaped.setBars=function(e){setBarValueAfterConvert(e)},shaped.changeSettings=function(e){function t(t,a,s,i){r===t&&(r=a+"_"+t,"show"===e[2]?n[r]=s:"hide"===e[2]&&(n[r]=i))}function a(t,a,s){r===t&&("yes"===e[2]?n[r]=a:"no"===e[2]&&(n[r]=s))}log(e);var r,s=!1,i=!1,n={};"npcs"===e[0]?s=!0:"pcs"===e[0]?i=!0:"all"===e[0]?(s=!0,i=!0):messageToChat('invalid target. Please send "npcs", "pcs", or "all"');var o=["output_option","death_save_output_option","initiative_output_option","show_character_name","initiative_tie_breaker","initiative_to_tracker","attacks_vs_target_ac","attacks_vs_target_name","gm_info","save_dc","save_failure","save_success","effects","recharge"];-1!==o.indexOf(e[1])?r=e[1]:messageToChat("invalid attribute. Please use one of the following: "+o.join(", "));var c=["hide","show","yes","no"];if(-1===c.indexOf(e[2]))return void messageToChat("invalid value. Please use one of the following: "+c.join(", "));("output_option"===r||"death_save_output_option"===r||"initiative_output_option"===r)&&("show"===e[2]?n[r]="@{output_to_all}":"hide"===e[2]&&(n[r]="@{output_to_gm}")),t("character_name","show","@{show_character_name_yes}","@{show_character_name_no}"),a("initiative_tie_breaker","((@{initiative_overall}) / 100)",""),a("initiative_to_tracker","@{initiative_to_tracker_yes}","@{initiative_to_tracker_no}"),a("attacks_vs_target_ac","@{attacks_vs_target_ac_yes}","@{attacks_vs_target_ac_no}"),a("attacks_vs_target_name","@{attacks_vs_target_name_yes}","@{attacks_vs_target_name_no}"),t("save_dc","hide","","@{hide_save_dc_var}"),t("save_failure","hide","","@{hide_save_failure_var}"),t("save_success","hide","","@{hide_save_success_var}"),t("effects","hide","","@{hide_effects_var}"),t("recharge","hide","","@{hide_recharge_var}"),"gm_info"===r&&("show"===e[2]?(n.hide_save_dc="",n.hide_save_failure="",n.hide_save_success="",n.hide_effects="",n.hide_recharge=""):"hide"===e[2]&&(n.hide_save_dc="@{hide_save_dc_var}",n.hide_save_failure="@{hide_save_failure_var}",n.hide_save_success="@{hide_save_success_var}",n.hide_effects="@{hide_effects_var}",n.hide_recharge="@{hide_recharge_var}"));var l=filterObjs(function(e){if("character"===e.get("type")){var t=parseInt(getAttrByName(e.id,"is_npc"),10);return s&&1===t||i&&0===t}return null});for(var h in n)n.hasOwnProperty(h)&&(l.forEach(function(e){var t=findObjs({_type:"attribute",_characterid:e.id,name:h})[0];t?t.get("current")&&t.get("current").toString()===n[h]||t.set({current:n[h]}):createObj("attribute",{name:h,current:n[h],characterid:e.id})}),messageToChat(l.length>0?"changed "+h+" to "+n[h].replace("@","&#64;")+" for "+l.length+" creatures":"no creatures match those parameters"))},shaped.importSpell=function(e,t,a){function r(e,t){e.damage&&(setAttribute(n+"spell_toggle_"+t+"_damage","@{spell_var_"+t+"_damage}"),setAttribute(n+"spell_"+t+"_dmg",e.damage)),e.damageBonus&&(setAttribute(n+"spell_toggle_bonuses","@{spell_var_bonuses}"),setAttribute(n+"spell_"+t+"_dmg_bonus",e.damageBonus)),e.castingStat&&setAttribute(n+"spell_"+t+"_dmg_stat","@{casting_stat}"),e.damageType&&setAttribute(n+"spell_"+t+"_dmg_type",e.damageType),e.secondaryDamage&&(setAttribute(n+"spell_toggle_"+t+"_second_damage","@{spell_var_"+t+"_second_damage}"),setAttribute(n+"spell_"+t+"_second_dmg",e.secondaryDamage)),e.secondaryDamageType&&setAttribute(n+"spell_"+t+"_second_dmg_type",e.secondaryDamageType),e.higherLevelDice&&(setAttribute(n+"spell_toggle_higher_lvl_query","@{higher_level_query}"),setAttribute(n+"spell_toggle_output_higher_lvl_query","@{spell_var_output_higher_lvl_query}"),setAttribute(n+"spell_"+t+"_higher_level_dmg_dice",e.higherLevelDice)),e.higherLevelDie&&setAttribute(n+"spell_"+t+"_higher_level_dmg_die",e.higherLevelDie),e.higherLevelSecondaryDice&&setAttribute(n+"spell_"+t+"_second_higher_level_dmg_dice",e.higherLevelSecondaryDice),e.higherLevelSecondaryDie&&setAttribute(n+"spell_"+t+"_second_higher_level_dmg_die",e.higherLevelSecondaryDie)}var s,i=fifthSpells.spellsData.filter(function(e){return e.name.toLowerCase()===a.toLowerCase()})[0],n="repeating_spellbook";if(!i)return void messageToChat('Error: cannot find a spell by the name of "'+a+'".');if("undefined"==typeof e)return void messageToChat('Error: cannot find a character by the name of "'+t+'".');characterId=e.id,n+=0===i.level?"cantrip_":"level"+i.level+"_";for(var o=0;100>o;o++){var c=findObjs({_type:"attribute",_characterid:characterId,name:n+o+"_spellname"})[0];if(!c){s=o,n+=s+"_";break}}if(setAttribute(n+"spellname",i.name),i.ritual&&setAttribute(n+"spellritual","{{spellritual=1}}"),i.concentration&&setAttribute(n+"spellconcentration","{{spellconcentration=1}}"),i.school&&setAttribute(n+"spellschool",i.school),i.castingTime&&("reaction"===i.castingTime?setAttribute(n+"spell_casting_time","@{spell_casting_time_reaction_var}"):"bonus"===i.castingTime?setAttribute(n+"spell_casting_time","@{spell_casting_time_bonus_var}"):"action"===i.castingTime?setAttribute(n+"spell_casting_time","@{spell_casting_time_action_var}"):"minute"===i.castingTime?setAttribute(n+"spell_casting_time","@{spell_casting_time_minute_var}"):(setAttribute(n+"spell_casting_time","@{spell_casting_time_longer_var}"),setAttribute(n+"spellcasttime",i.castingTime))),i.range&&setAttribute(n+"spellrange",i.range),i.target&&setAttribute(n+"spelltarget",i.target),i.aoe&&setAttribute(n+"spellaoe",i.aoe),i.components&&(i.components.verbal&&setAttribute(n+"spellcomponents_verbal","@{spellcomponents_verbal_var}"),i.components.somatic&&setAttribute(n+"spellcomponents_somatic","@{spellcomponents_somatic_var}"),i.components.material&&setAttribute(n+"spellcomponents_material","@{spellcomponents_material_var}"),i.components.materialMaterial&&setAttribute(n+"spellcomponents",i.components.materialMaterial)),i.duration&&setAttribute(n+"spellduration",i.duration),i.source&&setAttribute(n+"spellsource",i.source),i.description&&setAttribute(n+"spelldescription",i.description),i.higherLevel){setAttribute(n+"spellhighersloteffect",i.higherLevel);var l=!0;(i.attack&&i.attack.higherLevelDice||i.damage&&i.damage.higherLevelDice||i.save&&i.save.higherLevelDice||i.heal&&(i.heal.higherLevelDice||i.heal.higherLevelAmount))&&(l=!1),i.level>0&&l&&setAttribute(n+"spell_toggle_higher_lvl","@{spell_var_higher_lvl}")}if(i.emote){var h,d,u,g,_=getAttrByName(characterId,"gender","current");_&&_.match(/f|female|girl|woman|feminine/gi)?(h="she",d="her",u="her",g="herself"):(h="he",d="him",u="his",g="himself"),i.emote=i.emote.replace("{{GENDER_PRONOUN_HE_SHE}}",h).replace("{{GENDER_PRONOUN_HIM_HER}}",d).replace("{{GENDER_PRONOUN_HIS_HER}}",u).replace("{{GENDER_PRONOUN_HIMSELF_HERSELF}}",g),setAttribute(n+"spellemote",i.emote),setAttribute(n+"spell_toggle_emote","@{spell_var_emote}")}i.attack&&(setAttribute(n+"attackstat","@{casting_stat}"),setAttribute(n+"spell_toggle_attack","@{spell_var_attack}"),r(i.attack,"attack"),i.attack.damage&&setAttribute(n+"spell_toggle_attack_crit","@{spell_var_attack_crit}")),i.damage&&r(i.damage,"attack"),i.save&&(setAttribute(n+"spell_toggle_save","@{spell_var_save}"),i.save.condition&&setAttribute(n+"savecondition",i.save.condition),i.save.ability&&(setAttribute(n+"savestat",capitalizeFirstLetter(i.save.ability.substring(0,3))),setAttribute(n+"spellsavedc","@{casting_stat_dc}")),i.save.saveFailure&&setAttribute(n+"savefailure",i.save.saveFailure),i.save.saveSuccess&&setAttribute(n+"savesuccess",i.save.saveSuccess),r(i.save,"save")),i.heal&&(setAttribute(n+"spell_toggle_healing","@{spell_var_healing}"),setAttribute(n+"spellhealamount",i.heal.amount),i.heal.bonus&&setAttribute(n+"healbonus",i.heal.bonus),i.heal.castingStat&&setAttribute(n+"healstatbonus","@{casting_stat}"),(i.heal.higherLevelDice||i.heal.higherLevelAmount)&&setAttribute(n+"spell_toggle_higher_lvl_query","@{spell_var_higher_lvl_query}"),i.heal.higherLevelDice&&setAttribute(n+"spell_heal_higher_level_dmg_dice",i.heal.higherLevelDice),i.heal.higherLevelDie&&setAttribute(n+"spell_heal_higher_level_dmg_die",i.heal.higherLevelDie),i.heal.higherLevelAmount&&setAttribute(n+"spell_heal_higher_level_amount",i.heal.higherLevelAmount)),i.effects&&(setAttribute(n+"spelleffect",i.effects),setAttribute(n+"spell_toggle_effects","@{spell_var_effects}")),messageToChat(i.name+" imported for "+t+" on spell level "+i.level+" at index "+s)},shaped.spellImport=function(e,t){for(var a=t[0].split(", "),r=e.get("represents"),s=findObjs({_type:"character",id:r})[0],i=getAttrByName(r,"character_name","current"),n=0;n<a.length;n++)shaped.importSpell(s,i,a[n])}}("undefined"==typeof shaped?shaped={}:shaped),on("ready",function(){"use strict";shaped.statblock.RegisterHandlers()});