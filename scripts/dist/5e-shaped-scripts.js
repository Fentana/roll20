!function(shaped){function capitalizeFirstLetter(e){return e.charAt(0).toUpperCase()+e.slice(1)}function HandleInput(e){if(commandExecuter=e.who,shaped.settings.useAmmoAutomatically&&"5eDefault"===e.rolltemplate&&-1!==e.content.indexOf("{{ammo_auto=1}}")){for(var t,a,r,s=/\{\{(.*?)\}\}/gi;r=s.exec(e.content);)if(r[1]){var i=r[1].split("=");"character_name"===i[0]&&(t=i[1]),"ammo_field"===i[0]&&(a=i[1])}shaped.decrementAmmo(t,a)}if("api"===e.type){log("msg.content: "+e.content);var n=e.content.split(/\s+--/);switch(n[0]){case"!build-monster":case"!shaped-parse":case"!shaped-import":n[1]&&"clean"===n[1]&&shaped.getSelectedToken(e,shaped.deleteOldSheet),shaped.getSelectedToken(e,shaped.importStatblock);break;case"!shaped-rollhp":shaped.getSelectedToken(e,shaped.rollTokenHp);break;case"!shaped-settings":n.shift(),shaped.changeSettings(n);break;case"!shaped-spell":n.shift(),shaped.getSelectedToken(e,shaped.spellImport,n);break;case"!shaped-monster":n.shift(),shaped.getSelectedToken(e,shaped.monsterImport,n);break;case"!shaped-token":shaped.getSelectedToken(e,shaped.tokenMacros,n)}}}function messageToChat(e){log(e),sendChat("Shaped","/w gm "+e),commandExecuter&&-1===commandExecuter.indexOf("(GM)")&&sendChat("Shaped","/w "+commandExecuter+" "+e)}function capitalizeEachWord(e){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}function createInitTokenAction(e){setAbility("Init","","%{"+e+"|Initiative}",shaped.settings.createAbilityAsToken)}function createSaveQueryTokenAction(e){setAbility("Save","","%{"+e+"|save_query_macro}",shaped.settings.createAbilityAsToken)}function createCheckQueryTokenAction(e){setAbility("Check","","%{"+e+"|check_query_macro}",shaped.settings.createAbilityAsToken)}function setUserDefinedScriptSettings(){shaped.settings.defaultTab&&setAttribute("tab",shaped.settings.defaultTab),"hidden"===shaped.settings.sheetOutput&&setAttribute("output_option","@{output_to_gm}"),shaped.settings.whisperDeathSaves&&setAttribute("death_save_output_option","@{output_to_gm}"),shaped.settings.whisperInitiative&&setAttribute("initiative_output_option","@{output_to_gm}"),shaped.settings.showCharacterNameOnRollTemplate&&setAttribute("show_character_name","@{show_character_name_yes}"),shaped.settings.initiativeTieBreaker&&setAttribute("initiative_tie_breaker","((@{initiative_overall}) / 100)"),shaped.settings.initiativeAddsToTracker&&setAttribute("initiative_to_tracker","@{initiative_to_tracker_yes}"),shaped.settings.attacksVsTargetAC&&setAttribute("attacks_vs_target_ac","@{attacks_vs_target_ac_yes}"),shaped.settings.attacksVsTargetName&&setAttribute("attacks_vs_target_name","@{attacks_vs_target_name_yes}"),shaped.settings.hideGMInfo&&(setAttribute("hide_save_dc","@{hide_save_dc_var}"),setAttribute("hide_save_failure","@{hide_save_failure_var}"),setAttribute("hide_save_success","@{hide_save_success_var}"),setAttribute("hide_effects","@{hide_effects_var}"),setAttribute("hide_recharge","@{hide_recharge_var}"))}function logObject(e){for(var t in e)e.hasOwnProperty(t)?logObject(e[t]):log("logObj: "+t+"->"+e[t])}function sortNumber(e,t){return e-t}function setAttribute(e,t,a){if(!e)throw"Name required to set attribute";if(a=a||"",!t)return void messageToChat("Error setting empty value: "+e);var r=findObjs({_type:"attribute",_characterid:characterId,name:e})[0];r?r.get("current")&&r.get("current").toString()===t||r.set({current:t,max:a}):createObj("attribute",{name:e,current:t,max:a,characterid:characterId})}function setAbility(e,t,a,r){if(!e)throw"Name required to set ability";var s=findObjs({_type:"ability",_characterid:characterId,name:e});if(!s)throw"Something prevent script to create or find ability "+e;0===s.length?s=createObj("ability",{_characterid:characterId,name:e,description:t,action:a,istokenaction:r}):(s=getObj("ability",s[0].id),(s.get("description")!=t||s.get("action")!==a||s.get("istokenaction")!=r)&&s.set({description:t,action:a,istokenaction:r}))}function clean(e){return unescape(e).replace(/\s\./g,".").replace(/–/g,"-").replace(/<br[^>]*>/g,"#").replace(/\s*#\s*/g,"#").replace(/(<([^>]+)>)/gi,"").replace(/#(?=[a-z]|DC)/g," ").replace(/\s+/g," ").replace(/#Hit:/gi,"Hit:").replace(/Hit:#/gi,"Hit: ").replace(/#Each /gi,"Each ").replace(/#On a successful save/gi,"On a successful save").replace(/DC#(\d+)/g,"DC $1").replace("LanguagesChallenge","Languages -#Challenge").replace("' Speed","Speed").replace(/#Medium or/gi," Medium or").replace(/take#(\d+)/gi,"take $1")}function sanitizeText(e){"string"!=typeof e&&(e=e.toString()),e=e.replace(/\,\./gi,",").replace(/ft\s\./gi,"ft.").replace(/ft\.\s\,/gi,"ft").replace(/ft\./gi,"ft").replace(/(\d+) ft\/(\d+) ft/gi,"$1/$2 ft").replace(/lOd/g,"10d").replace(/dl0/gi,"d10").replace(/dlO/gi,"d10").replace(/dl2/gi,"d12").replace(/Sd(\d+)/gi,"5d$1").replace(/ld(\d+)/gi,"1d$1").replace(/ld\s+(\d+)/gi,"1d$1").replace(/(\d+)d\s+(\d+)/gi,"$1d$2").replace(/(\d+)\s+d(\d+)/gi,"$1d$2").replace(/(\d+)\s+d(\d+)/gi,"$1d$2").replace(/(\d+)d(\d)\s(\d)/gi,"$1d$2$3").replace(/(\d+)j(?:Day|day)/gi,"$1/Day").replace(/(\d+)f(?:Day|day)/gi,"$1/Day").replace(/(\d+)j(\d+)/gi,"$1/$2").replace(/(\d+)f(\d+)/gi,"$1/$2").replace(/{/gi,"(").replace(/}/gi,")").replace(/(\d+)\((\d+) ft/gi,"$1/$2 ft").replace(/• /gi,"").replace(/’/gi,"'"),e=e.replace(/(\d+)\s*?plus\s*?((?:\d+d\d+)|(?:\d+))/gi,"$2 + $1");var t={jday:"/day","abol eth":"aboleth","ACT IONS":"ACTIONS",Afrightened:"A frightened",Alesser:"A lesser","Athl etics":"Athletics",Aundefinedr:"After","blindn ess":"blindness","blind sight":"blindsight",bofh:"both","brea stplate":"breastplate","choos in g":"choosing","com muni cate":"communicate","Constituti on":"Constitution","creatu re":"creature","darkvi sion":"darkvision","dea ls":"deals","di sease":"disease","di stance":"distance","fa lls":"falls","fe et":"feet","exha les":"exhales","ex istence":"existence",lfthe:"If the",Ifthe:"If the",lnt:"Int","magica lly":"magically",minlilte:"minute","natura l":"natural",ofeach:"of each",ofthe:"of the","on'e":"one","0n":"on","pass ive":"passive","Perce ption":"Perception","radi us":"radius","ra nge":"range","rega ins":"regains","rest.oration":"restoration","savin g":"saving","si lvery":"silvery","s lashing":"slashing","slas hing":"slashing","slash in g":"slashing","slash ing":"slashing","Spel/casting":"Spellcasting","successfu l":"successful","ta rget":"target"," Th e ":" The ",t_urns:"turns","unti l":"until","withi n":"within"},a=new RegExp(Object.keys(t).join("|"),"gi");return e=e.replace(a,function(e){return t[e]})}function findKeyword(e){for(var t={attr:{},traits:{},actions:{},lair:{},legendary:{},reactions:{}},a=0,r=e.length,s=e.length,i=e.length,n=/#\s*(tiny|small|medium|large|huge|gargantuan|armor class|hit points|speed|str|dex|con|int|wis|cha|saving throws|skills|damage resistances|damage immunities|condition immunities|damage vulnerabilities|senses|languages|challenge|traits|actions|lair actions|legendary actions|reactions)(?=\s|#)/gi;c=n.exec(e);){var o=c[1].toLowerCase();"actions"===o?(a=c.index,t.actions.Actions=c.index):"legendary actions"===o?(s=c.index,t.legendary.Legendary=c.index):"reactions"===o?(i=c.index,t.reactions.Reactions=c.index):"lair actions"===o?(r=c.index,t.lair.Lair=c.index):t.attr[o]=c.index}n=/(?:#)([A-Z][\w-\']+(?:\s(?:[A-Z][\w-\']+|[\(\)\/\d\-]|of|and|or|a)+)*)(?=\s*\.)/gi,log("parsed statblock: "+e);for(var c;c=n.exec(e);)t.attr[c[1].toLowerCase()]||(c.index<a?t.traits[c[1]]=c.index:c.index>a&&c.index<s&&c.index<i&&c.index<r?t.actions[c[1]]=c.index:c.index>s&&c.index<i&&c.index<r?t.legendary[c[1]]=c.index:c.index>i&&c.index<r?t.reactions[c[1]]=c.index:c.index>r&&(t.lair[c[1]]=c.index));var l=e.split("#"),d="",h=[],u=1;for(var g in t.actions)t.actions.hasOwnProperty(g)&&h.push(t.actions[g]);for(var p in t.legendary)t.legendary.hasOwnProperty(p)&&h.push(t.legendary[p]);for(var _ in t.lair)t.lair.hasOwnProperty(_)&&h.push(t.lair[_]);h.sort(sortNumber);for(var m,f=h[h.length-1]+1;6>u;)d=l[l.length-u],m=e.indexOf(d),m>f&&(t.traits.Description=m-1),u++;return t}function splitStatblock(e,t){var a,r,s,i=[];for(a in t)if(t.hasOwnProperty(a)){r=t[a];for(s in r)r.hasOwnProperty(s)&&i.push(r[s])}i.sort(sortNumber),t.attr.name=extractSection(e.substring(0,i[0]),"name");for(a in t)if(t.hasOwnProperty(a)){r=t[a];for(s in r)if(r.hasOwnProperty(s)){var n=r[s],o=i.indexOf(n)+1,c=i[o]||e.length;t[a][s]=extractSection(e.substring(n,c),s)}}delete t.actions.Actions,delete t.legendary.Legendary,delete t.reactions.Reactions;for(var l=["str","dex","con","int","wis","cha"],d="",h=0,u=l.length;u>h;++h)t.attr.hasOwnProperty([l[h]])&&(d+=t.attr[l[h]]+" ",delete t.attr[l[h]]);t.attr.abilities=d;var g=["tiny","small","medium","large","huge","gargantuan"];for(h=0,u=g.length;u>h;++h)if(t.attr.hasOwnProperty([g[h]])){t.attr.size=g[h]+" "+t.attr[g[h]],delete t.attr[g[h]];break}return t}function extractSection(e,t){return e.replace(new RegExp("^[\\s\\.#]*"+t.replace(/([-()\\/])/g,"\\$1")+"?[\\s\\.#]*","i"),"").replace(/#/g," ")}function processSection(e){e.attr.abilities&&parseAbilities(e.attr.abilities),e.attr.size&&parseSize(e.attr.size),e.attr["armor class"]&&parseArmorClass(e.attr["armor class"]),e.attr["hit points"]&&parseHp(e.attr["hit points"]),e.attr.speed&&parseSpeed(e.attr.speed),e.attr.challenge&&parseChallenge(e.attr.challenge),e.attr["saving throws"]&&parseSavingThrow(e.attr["saving throws"]),e.attr.skills&&parseSkills(e.attr.skills),e.attr.senses&&parseSenses(e.attr.senses),e.attr["damage immunities"]&&setAttribute("damage_immunity",e.attr["damage immunities"]),e.attr["condition immunities"]&&setAttribute("condition_immunity",e.attr["condition immunities"]),e.attr["damage vulnerabilities"]&&setAttribute("damage_vulnerability",e.attr["damage vulnerabilities"]),e.attr["damage resistances"]&&setAttribute("damage_resistance",e.attr["damage resistances"]),e.attr.languages&&setAttribute("prolanguages",e.attr.languages),parseTraits(e.traits),parseReactions(e.reactions),parseActions(e.actions),parseActions(e.legendary,"legendary_"),parseActions(e.lair,"lair_")}function parseAbilities(e){for(var t,a=/(\d+)\s*\(/g,r=[];t=a.exec(e);)r.push(t[1]);setAttribute("strength",r[0]),setAttribute("dexterity",r[1]),setAttribute("constitution",r[2]),setAttribute("intelligence",r[3]),setAttribute("wisdom",r[4]),setAttribute("charisma",r[5])}function parseSize(e){var t=e.match(/(.*?) (.*?), (.*)/i);if(!(t&&t[1]&&t[2]&&t[3]))throw"Character doesn't have valid type/size/alignment format";setAttribute("size",capitalizeEachWord(t[1])),setAttribute("npc_type",capitalizeEachWord(t[2])),setAttribute("alignment",capitalizeEachWord(t[3]))}function parseArmorClass(e){var t=e.match(/(\d+)\s?(.*)/);if(!t||!t[1])throw"Character doesn't have valid AC format";setAttribute("npc_AC",t[1]),t[2]&&setAttribute("npc_AC_note",t[2].replace(/\(|\)/g,""))}function parseHD(e){for(var t,a=/(\d+)d(\d+)/gi;t=a.exec(e);){if(!t||!t[1]||!t[2])throw"Character doesn't have valid hd format";var r=t[1],s="d"+t[2];setAttribute("hd_"+s,r,r),setAttribute("hd_"+s+"_toggle","on")}}function parseHp(e){var t=e.match(/(\d+)\s?\(([\dd\s\+\-]*)\)/i);if(!t||!t[1]||!t[2])throw"Character doesn't have valid HP/HD format";setAttribute("HP",t[1],t[1]),setAttribute("npc_HP_hit_dice",t[2]),parseHD(t[2])}function parseSpeed(e){for(var t,a="speed",r=/(|burrow|climb|fly|swim|)\s*(\d+)\s*?(?:ft)?\s*(\(.*\))?/gi;t=r.exec(e);){if(!t[2])throw"Character doesn't have valid speed format";var s=a+(""!==t[1]?"_"+t[1].toLowerCase():""),i=t[2];t[3]&&t[3].indexOf("hover")&&setAttribute("speed_fly_hover","on"),setAttribute(s,i)}}function parseSenses(e){e=e.replace(/[,\s]*passive.*/i,"");for(var t,a=/(|blindsight|darkvision|tremorsense|truesight|)\s*?(\d+)\s*?ft?\s*(\(.*\))?/gi;t=a.exec(e);){if(!t||!t[1]||!t[2])throw"Character doesn't have valid senses format";var r=t[1].toLowerCase(),s=t[2];t[3]&&t[3].indexOf("blind beyond")&&setAttribute("blindsight_blind_beyond","on"),setAttribute(r,s)}}function setTokenVision(e){var t,a,r=parseInt(getAttrByName(characterId,"blindsight"),10)||0,s=parseInt(getAttrByName(characterId,"darkvision"),10)||0,i=parseInt(getAttrByName(characterId,"tremorsense"),10)||0,n=parseInt(getAttrByName(characterId,"truesight"),10)||0,o=Math.max(r,s,i,n),c=Math.max(r,i,n);o===r?(t=r,a=r):o===i?(t=i,a=i):o===n?(t=n,a=n):o===s&&(t=Math.ceil(1.1666666*s),a=c>0?c:-5),t>0&&e.set("light_radius",t),a&&e.set("light_dimradius",a),e.set("light_hassight",!0),e.set("light_angle",360),e.set("light_losangle",360)}function parseChallenge(e){var t=e.replace(/[, ]/g,""),a=t.match(/([\d\/]+).*?(\d+)/);setAttribute("challenge",a[1]);var r=parseInt(a[2]);getAttrByName(characterId,"xp")!==r&&setAttribute("xp",r)}function parseSavingThrow(save){for(var regex=/(STR|DEX|CON|INT|WIS|CHA).*?(\d+)/gi,attr,match;match=regex.exec(save);){switch(match[1].toLowerCase()){case"str":attr="strength";break;case"dex":attr="dexterity";break;case"con":attr="constitution";break;case"int":attr="intelligence";break;case"wis":attr="wisdom";break;case"cha":attr="charisma"}setAttribute(attr+"_save_prof","@{PB}");var proficiencyBonus=2+Math.floor(Math.abs((eval(getAttrByName(characterId,"challenge"))-1)/4)),totalSaveBonus=match[2]-proficiencyBonus-Math.floor((getAttrByName(characterId,attr)-10)/2);0!==totalSaveBonus&&setAttribute(attr+"_save_bonus",totalSaveBonus)}}function parseSkills(skills){for(var skillAbility={acrobatics:"dexterity","animal handling":"wisdom",arcana:"intelligence",athletics:"strength",deception:"charisma",history:"intelligence",insight:"wisdom",intimidation:"charisma",investigation:"intelligence",medicine:"wisdom",nature:"intelligence",perception:"wisdom",performance:"charisma",persuasion:"charisma",religion:"intelligence","sleight of hand":"dexterity",stealth:"dexterity",survival:"wisdom"},extraSkillAbility={"alchemist's supplies":"intelligence","navigator's tools":"wisdom","thieves' tools":"dexterity"},regex=/([\w\s\']+).*?(\d+)/gi,customSkillNum=0,match;match=regex.exec(skills.replace(/Skills\s+/i,""));){var skill=match[1].trim().toLowerCase(),proficiencyBonus=2+Math.floor(Math.abs((eval(getAttrByName(characterId,"challenge"))-1)/4)),expertise=2*proficiencyBonus,abilitymod,attr,totalSkillBonus;skill in skillAbility?(abilitymod=skillAbility[skill],attr=skill.replace(/\s/g,""),totalSkillBonus=match[2]-Math.floor((getAttrByName(characterId,abilitymod)-10)/2),totalSkillBonus>=expertise?(setAttribute(attr+"_prof_exp","@{exp}"),totalSkillBonus>expertise&&setAttribute(attr+"_bonus",totalSkillBonus-expertise)):totalSkillBonus>=proficiencyBonus?(setAttribute(attr+"_prof_exp","@{PB}"),totalSkillBonus>proficiencyBonus&&setAttribute(attr+"_bonus",totalSkillBonus-proficiencyBonus)):(setAttribute(attr+"_prof_exp","@{jack_of_all_trades}"),totalSkillBonus>0&&setAttribute(attr+"_bonus",totalSkillBonus))):skill in extraSkillAbility?(customSkillNum++,abilitymod=extraSkillAbility[skill],attr="custom_skill_"+customSkillNum,totalSkillBonus=match[2]-Math.floor((getAttrByName(characterId,abilitymod)-10)/2),setAttribute(attr+"_name",capitalizeEachWord(skill)),log("added "+capitalizeEachWord(skill)+" to custom skills"),totalSkillBonus>=expertise?(setAttribute(attr+"_prof_exp","@{exp}"),totalSkillBonus>expertise&&setAttribute(attr+"_bonus",totalSkillBonus-expertise)):totalSkillBonus>=proficiencyBonus?(setAttribute(attr+"_prof_exp","@{PB}"),totalSkillBonus>proficiencyBonus&&setAttribute(attr+"_bonus",totalSkillBonus-proficiencyBonus)):(setAttribute(attr+"_prof_exp","@{jack_of_all_trades}"),totalSkillBonus>0&&setAttribute(attr+"_bonus",totalSkillBonus))):errors.push("Skill "+skill+" is not a valid skill"),customSkillNum>0&&setAttribute("custom_skills_toggle","on")}}function parseTraits(e){var t=[];if(_.each(e,function(e,a){t.push("**"+a+"**. "+e)}),t.length>0){var a=t.join("\n");setAttribute("npc_traits",a)}}function parseReactions(e){var t=[];_.each(e,function(e,a){t.push("**"+a+"**. "+e)}),t.length>0&&(setAttribute("reactions",t.join("\n")),setAttribute("toggle_reactions","on"))}function parseActions(e,t){function a(e){function a(e,a,r){"undefined"==typeof r&&(r=a),r&&setAttribute("repeating_"+t+"actions_"+T+"_"+e,a.trim())}function r(e,a){("undefined"==typeof a||a)&&setAttribute("repeating_"+t+"actions_"+T+"_toggle_"+e,"@{repeating_"+t+"actions_"+T+"_var_"+e+"}")}function s(e){return e.replace(/\s?[\+\-]\s?\d+/g,"")}function n(e){a("name",e)}function o(e){a("type",e)}function c(e){a("target",e),r("target")}function l(e){a("range",e),r("range")}function d(e,t){a(t+"dmg",e)}function h(e){r(e+"damage")}function u(e,t){a(t+"dmg_type",e)}function g(e,t){a(t+"crit_dmg",e)}function p(e){a("alt_dmg_reason",e)}function m(e){e&&a("effect",e.replace(/(\s*?Hit:\s?)/gi,"").replace(/(\d+)d(\d+)/g,"[[$1d$2]]").replace(/\s(\d+)\s/g," [[$1]] ")),r("effects",e)}function f(e){a("save_dc",e)}function v(e){e&&a("save_stat",e.substring(0,3))}function b(e){r("save",e)}function A(e){r("save_damage",e)}function k(e){a("save_dmg",e)}function y(e){a("save_dmg_type",e)}function x(e){a("save_success",e)}function w(e){m(e)}function S(e,t){e&&(e[1]&&(e[2]=e[1]),e[2]&&(d(e[2],t),g(s(e[2]),t)),e[4]&&(e[3]+=" "+e[4]),e[3]&&u(e[3],t),(e[2]||e[3])&&h(t),e[5]&&m(e[5].trim()),e[6]&&p(e[6]))}var T=0,C=[],O=/\,?\.?\s*?/,N=/\,?\.?\s*/,B=/\,?\.?\s?/,I=/Hit:.*?/,E=/((?:[\w]+|[\w]+\s(?:or|and)\s[\w]+)(?:\s*?\([\w\s]+\))?)\s*?damage\s?(\([\w\'\s]+\))?/,D=/(?:(\d+)|.*?\(([\dd\s\+\-]*)\).*?)\s*?/,L=/(?:\,\s*?or\s*?)/,j=/((?:if|in)[\w\s]+)/,H=/(The.*|If the.*)?/,M=/\s*?plus\s*?/,R=/(?:DC)\s*?(\d+)\s*?([a-zA-Z]*)\s*?(?:saving throw)/,P=/\,?\s*?(?:taking|or take)/,$=/(?: against disease)?/,z=/(?:.*or\s(.*)?\son a successful one.)?/,q=/(?:On a successful save,)?(.*)?/,Q=/(?:On a (?:failure|failed save))\,\s(?:(.*). On a success,\s(.*)?)?(.*)?/,U=/(\s?and.*)?/,V=/(or\s(?!take).*)/,W=/(.*)?/,G=new RegExp(I.source+D.source+E.source+O.source+U.source,"i"),F=new RegExp(M.source+D.source+E.source+O.source+W.source,"i"),Z=new RegExp(L.source+D.source+E.source+O.source+j.source+B.source+H.source,"i"),K=new RegExp(I.source+W.source,"i"),J=new RegExp(R.source+P.source+D.source+E.source+z.source+O.source+W.source+q.source,"i"),X=new RegExp(R.source+$.source+N.source+V.source,"i"),Y=new RegExp(R.source+O.source+Q.source,"i");_.each(e,function(e,s){function d(){setAbility(s,"","%{"+characterName+"|repeating_"+t+"actions_"+T+"_action}",shaped.settings.createAbilityAsToken)}var h,u=!1,g=!1,p=!1,_=s.indexOf("(");_>1?i[T]=s.substring(0,_-1).toLowerCase():i[T]=s.toLowerCase();for(var O,N=/\s*?\((?:Recharge\s*?(\d+\-\d+|\d+)|Recharges\safter\sa\s(.*))\)/gi;O=N.exec(s);){var B=O[1]||O[2];a("recharge",B),r("recharge"),B&&(s=s.replace(N,""))}for(var I,E=/\s*?\((\d+\/Day)\)/gi;I=E.exec(s);){var D=I[1]||I[2];a("recharge",D),r("recharge"),D&&(s=s.replace(E,""),s=s.replace(E,""))}n(s);for(var L,j=e.split(/\.(.+)?/),H=j[0],M=H.split(","),R=/(melee|ranged|melee or ranged)\s*(spell|weapon)\s*/gi;L=R.exec(M[0]);){if(L[1]){var P="Melee or Ranged";L[1].toLowerCase()===P.toLowerCase()&&(L[1]="Thrown"),o(capitalizeEachWord(L[1]))}u=!0}for(var $,z=/\+\s?(\d+)\s*(?:to hit)/gi;$=z.exec(M[0]);)$[1]&&(a("tohit",$[1]),r("attack"),r("crit")),M[2]&&c(M[2].trim().toLowerCase()),u=!0;for(var q,Q=/(?:reach)\s?(\d+)\s?(?:ft)/gi;q=Q.exec(M[1]);)q[1]&&(a("reach",q[1]+" ft",q[1]),r("reach")),u=!0;for(var U,V=/(?:range)\s?(\d+)\/(\d+)\s?(ft)/gi;U=V.exec(M[1]);)U[1]&&U[2]&&l(U[1]+"/"+U[2]+" ft"),u=!0;var W=G.exec(e);if(W)S(W,"");else{var ee=K.exec(e);ee&&ee[1]&&m(ee[1].trim())}var te=F.exec(e);te&&S(te,"second_");var ae=Z.exec(e);ae&&(ae[6]=[ae[5],ae[5]=ae[6]][0],S(ae,"alt_")),W=G.exec(e),re&&S(W,"");var re=J.exec(e);re&&(re[1]&&f(re[1]),re[2]&&v(re[2]),re[3]&&(re[4]=re[3]),re[4]&&k(re[4]),re[6]&&(re[5]+=" "+re[6]),re[5]&&y(re[5]),re[9]&&(re[7]=re[9]),re[7]&&x(re[7]),re[8]&&w(re[8]),(re[1]||re[2]||re[8])&&b(),(re[4]||re[5]||re[7])&&A(),g=!0);var se=X.exec(e);se&&(se[1]&&f(se[1]),se[2]&&v(se[2]),se[3]&&w(se[3]),(se[1]||se[2]||se[3])&&b(),g=!0);var ie=Y.exec(e);ie&&(ie[1]&&f(ie[1]),ie[2]&&v(ie[2]),ie[5]&&(ie[3]=ie[5]),ie[3]&&w(ie[3]),ie[4]&&x(ie[4]),(ie[1]||ie[2]||ie[3]||ie[4])&&b(),g=!0);for(var ne,oe=/((?:Each | a | an | one ).*(?:creature|target).*)\s(?:within|in)\s*?a?\s*?(\d+)\s*?(?:feet|ft)/gi;ne=oe.exec(e);)ne[1]&&c(ne[1].trim()),ne[2]&&l(ne[2]+" ft",ne[2]);var ce=/(\d+)\-foot line\s*?that is (\d+) feet wide/gi,le=ce.exec(e),de=/line that is (\d+)\sfeet long\s*?and (\d+) feet wide/gi,he=de.exec(e),ue=le||he;ue&&(o("Line"),ue[1]&&ue[2]?l(ue[1]+"-foot line that is "+ue[2]+" feet wide"):ue[1]&&l(ue[1]));for(var ge,pe=/\.\s*(.*in that line)/gi;ge=pe.exec(e);)c(ge[1]);h=u||p||g,h?("legendary_"===t&&C.push(s+". See below"),s.indexOf("Costs ")>0&&(s=s.replace(/\s*\(Costs\s*\d+\s*Actions\)/gi,""),n(s)),d(),T++):"legendary_"===t?C.push(s+". "+e):(m(e),d(),T++)}),C.length>0&&setAttribute("legendary_action_notes",C.join("\n"))}function r(e){""!==u&&(u+="\n"),u+="%{"+characterName+"|repeating_actions_"+e+"_action}"}t||(t="");var s,i=[];shaped.settings.addInitiativeTokenAbility&&createInitTokenAction(characterName),shaped.settings.addSaveQueryMacroTokenAbility&&createSaveQueryTokenAction(characterName),shaped.settings.addCheckQueryMacroTokenAbility&&createCheckQueryTokenAction(characterName);var n;for(var o in e){n=/Multiattack(?:\s*(\(.*\)))?/gi;var c=n.exec(o);if(s="",c){c[1]&&(s=c[1]+": "),s+=e[o],setAttribute("multiattack",s),delete e[o],setAttribute("toggle_multiattack","on"),setAbility("MultiAtk","","%{"+characterName+"|multiattack}",shaped.settings.createAbilityAsToken);break}}if(a(e),"lair_"===t&&Object.keys(e).length>0&&setAttribute("toggle_lair_actions","on"),"legendary_"===t&&Object.keys(e).length>0&&setAttribute("toggle_legendary_actions","on"),s){var l=i.join("|");n=new RegExp("(one|two|three)? (?:with its )?("+l+")( or)?","gi");for(var d,h,u="";h=n.exec(s);){var g=h[2],p=h[1]||"one";d=i.indexOf(g.toLowerCase()),-1!==d&&(r(d),"two"==p&&r(d),"three"==p&&r(d),h[3]&&(u+="or\n"),delete i[d])}setAttribute("multiattack_script",u)}}function clearBar(e,t){e.set(t+"_link",""),e.set(t+"_value",""),e.set(t+"_max","")}function setBarValueAfterConvert(e){for(var t=0;3>t;t++){var a=shaped.settings.bar[t].name,r="bar"+(t+1);if(""!==a){var s,i,n,o=findObjs({name:a,_type:"attribute",_characterid:characterId},{caseInsensitive:!0})[0];o?(s=o.id,i=o.attributes.current,n=o.attributes.max):s="sheetattr_"+a,shaped.settings.bar[t].link?e.set(r+"_link",s):e.get(r+"_link")&&(log(r+": link isn't set in the bar settings, clearing link"),e.set(r+"_link","")),a?e.set(r+"_value",i):e.get(r+"_value")&&(log(r+": current isn't set in the bar settings, clearing current"),e.set(r+"_value","")),shaped.settings.bar[t].max?e.set(r+"_max",n):e.get(r+"_max")&&(log(r+": max isn't set in the bar settings, clearing max"),e.set(r+"_max",""))}else log(r+": no defined bar setting in shaped-scripts (at the top of the page), clearing "+r+"."),clearBar(e,r)}}shaped.settings={createAbilityAsToken:!0,rollMonsterHpOnDrop:!0,showName:!0,showNameToPlayers:!1,showCharacterNameOnRollTemplate:!1,sheetOutput:"",whisperDeathSaves:!0,initiativeTieBreaker:!0,whisperInitiative:!0,initiativeAddsToTracker:!0,addInitiativeTokenAbility:!0,attacksVsTargetAC:!1,attacksVsTargetName:!1,addSaveQueryMacroTokenAbility:!0,addCheckQueryMacroTokenAbility:!0,useAmmoAutomatically:!0,bar:[{name:"npc_AC",max:!1,link:!0,show:!1},{name:"",max:!1,link:!1,show:!1},{name:"HP",max:!0,link:!1,show:!1}]},shaped.statblock={version:"Dec 2nd, 2015",addTokenCache:[],RegisterHandlers:function(){on("chat:message",HandleInput),shaped.settings.rollMonsterHpOnDrop&&(on("add:graphic",function(e){shaped.statblock.addTokenCache.push(e.id)}),on("change:graphic",function(e){shaped.rollTokenHpOnDrop(e)})),log("Shaped Scripts ready")}};var status="",errors=[],characterId=null,characterName=null,commandExecuter=null;shaped.getSelectedToken=shaped.getSelectedToken||function(e,t){try{if(!e.selected||!e.selected.length)throw"No token selected";for(var a=0;a<e.selected.length;a++)if("graphic"===e.selected[a]._type){var r=getObj("graphic",e.selected[a]._id);r&&"token"===r.get("subtype")&&t(r,arguments[2])}}catch(s){messageToChat("Exception: "+s)}},shaped.deleteOldSheet=function(e){var t=e.get("represents"),a=findObjs({_type:"character",id:t})[0];a&&(a.remove(),log("old sheet removed before importing"))},shaped.deleteOldSheetByName=function(e){var t=findObjs({_type:"character",name:e})[0];t&&(t.remove(),log("old sheet removed before importing"))},shaped.tokenMacros=function(e,t){var a=e.get("represents"),r=findObjs({_type:"character",id:a})[0],s=getAttrByName(a,"character_name","current");return"undefined"==typeof r?void messageToChat('Error: cannot find a character by the name of "'+s+'".'):(characterId=r.id,void("init"===t[1]?(createInitTokenAction(s),messageToChat("created init token macro for "+s+".")):"query"===t[1]?(createSaveQueryTokenAction(s),createCheckQueryTokenAction(s),messageToChat("created query token macros for "+s+".")):"bootstrap"===t[1]&&(createInitTokenAction(s),createSaveQueryTokenAction(s),createCheckQueryTokenAction(s),messageToChat("bootstraped all token macros for "+s+"."))))},shaped.decrementAmmo=function(e,t){var a=findObjs({_type:"character",name:e})[0],r=findObjs({_type:"attribute",_characterid:a.id,name:t})[0],s=parseInt(r.get("current"),10)||0;r.set({current:s-1})},shaped.rollTokenHpOnDrop=function(e){commandExecuter=null,_.contains(shaped.statblock.addTokenCache,e.id)&&"graphic"===e.get("type")&&"token"===e.get("subtype")&&(shaped.statblock.addTokenCache=_.without(shaped.statblock.addTokenCache,e.id),shaped.rollTokenHp(e))},shaped.rollTokenHp=function(e){for(var t,a=0;3>a;a++)if("HP"===shaped.settings.bar[a].name){t=a+1;break}if(!t)return void messageToChat('One of the bar names has to be set to "HP" for random HP roll');var r="bar"+t,s=e.get("represents");if(""===s)messageToChat("Token does not represent a character");else if(""!==e.get(r+"_link"))messageToChat("Token "+r+" is linked");else{var i=getAttrByName(s,"is_npc","current");if(1===i||"1"===i){for(var n=[4,6,8,10,12,20],o="",c="",l=0,d=0,h=parseInt(getAttrByName(s,"constitution","current"),10),u=Math.floor((h-10)/2),g=0;g<n.length;g++){var p=parseInt(getAttrByName(s,"hd_d"+n[g],"current"),10);if(p){""!==c&&(c+=" + "),d+=p,c+=p+"d"+n[g];for(var m=0;p>m;m++)""!==o&&(o+=" + "),o+="{d"+n[g]+" + "+u+", 0d0+1}kh1",l+=n[g]/2+.5+u}}if(c+=" + "+u*d,""===o)return void messageToChat("Character does not have any hit dice, cannot roll");sendChat("Shaped","/roll "+o,function(t){var a=JSON.parse(t[0].content);_.has(a,"total")&&(e.set(r+"_value",a.total),e.set(r+"_max",a.total),messageToChat("HP ("+c+") | average: "+Math.floor(l)+" | rolled: "+a.total))})}}log("Still working after trying to roll hp")},shaped.setCharacter=function(e,t){if(!characterName)throw"Name require to get or create character";var a=findObjs({_type:"character",name:characterName});if(0===a.length?(a=createObj("character",{name:characterName,avatar:e.get("imgsrc")}),status=characterName+" created"):(a=getObj("character",a[0].id),status=characterName+" updated"),!a)throw"Something prevent script to create or find character "+characterName;return t&&a.set({gmnotes:t}),characterId=a.id,1!==getAttrByName(characterId,"is_npc")&&setAttribute("is_npc",1),a},shaped.importStatblock=function(e){status="Nothing modified",errors=[];var t=e.get("gmnotes").trim();if(""===t)throw"Selected token GM Notes was empty.";if(shaped.parseStatblock(e,t),characterId){e.set("represents",characterId);var a=characterName;shaped.settings.useAaronsNumberedScript&&1!==characterName.indexOf("%%NUMBERED%%")&&(a+=" %%NUMBERED%%"),e.set("name",a),shaped.settings.showName&&e.set("showname",!0),shaped.settings.showNameToPlayers&&e.set("showplayers_name",!0),setUserDefinedScriptSettings(),setBarValueAfterConvert(e),shaped.settings.bar[0].show&&e.set("showplayers_bar1","true"),shaped.settings.bar[1].show&&e.set("showplayers_bar2","true"),shaped.settings.bar[2].show&&e.set("showplayers_bar3","true"),setTokenVision(e)}messageToChat(status),errors.length>0&&messageToChat("Error(s): "+errors.join("\n/w GM "))},shaped.parseStatblock=function(e,t){log("---- Parsing statblock ----");var a=sanitizeText(clean(t)),r=findKeyword(a),s=splitStatblock(a,r);characterName=capitalizeEachWord(s.attr.name.toLowerCase()),shaped.setCharacter(e,a.replace(/#/g,"<br>")),processSection(s)},shaped.setBars=function(e){setBarValueAfterConvert(e)},shaped.changeSettings=function(e){function t(t,a,r,i){s===t&&(s=a+"_"+t,"show"===e[2]?o[s]=r:"hide"===e[2]&&(o[s]=i))}function a(t,a,r){s===t&&("yes"===e[2]?o[s]=a:"no"===e[2]&&(o[s]=r))}function r(e,t){d.forEach(function(a){var r=findObjs({_type:"attribute",_characterid:a.id,name:t})[0];r?r.get("current")&&r.get("current").toString()===e[t]||r.set({current:e[t]}):createObj("attribute",{name:t,current:e[t],characterid:a.id})}),messageToChat(d.length>0?"changed "+t+" to "+e[t].replace("@","&#64;")+" for "+d.length+" creatures":"no creatures match those parameters")}log(e);var s,i=!1,n=!1,o={};"npcs"===e[0]?i=!0:"pcs"===e[0]?n=!0:"all"===e[0]?(i=!0,n=!0):messageToChat('invalid target. Please send "npcs", "pcs", or "all"');var c=["output_option","death_save_output_option","initiative_output_option","show_character_name","initiative_tie_breaker","initiative_to_tracker","attacks_vs_target_ac","attacks_vs_target_name","gm_info","save_dc","save_failure","save_success","effects","recharge"];-1!==c.indexOf(e[1])?s=e[1]:messageToChat("invalid attribute. Please use one of the following: "+c.join(", "));var l=["hide","show","yes","no"];if(-1===l.indexOf(e[2]))return void messageToChat("invalid value. Please use one of the following: "+l.join(", "));("output_option"===s||"death_save_output_option"===s||"initiative_output_option"===s)&&("show"===e[2]?o[s]="@{output_to_all}":"hide"===e[2]&&(o[s]="@{output_to_gm}")),t("character_name","show","@{show_character_name_yes}","@{show_character_name_no}"),a("initiative_tie_breaker","((@{initiative_overall}) / 100)",""),a("initiative_to_tracker","@{initiative_to_tracker_yes}","@{initiative_to_tracker_no}"),a("attacks_vs_target_ac","@{attacks_vs_target_ac_yes}","@{attacks_vs_target_ac_no}"),a("attacks_vs_target_name","@{attacks_vs_target_name_yes}","@{attacks_vs_target_name_no}"),t("save_dc","hide","","@{hide_save_dc_var}"),t("save_failure","hide","","@{hide_save_failure_var}"),t("save_success","hide","","@{hide_save_success_var}"),t("effects","hide","","@{hide_effects_var}"),t("recharge","hide","","@{hide_recharge_var}"),"gm_info"===s&&("show"===e[2]?(o.hide_save_dc="",o.hide_save_failure="",o.hide_save_success="",o.hide_effects="",o.hide_recharge=""):"hide"===e[2]&&(o.hide_save_dc="@{hide_save_dc_var}",o.hide_save_failure="@{hide_save_failure_var}",o.hide_save_success="@{hide_save_success_var}",o.hide_effects="@{hide_effects_var}",o.hide_recharge="@{hide_recharge_var}"));var d=filterObjs(function(e){if("character"===e.get("type")){var t=parseInt(getAttrByName(e.id,"is_npc"),10);return i&&1===t||n&&0===t}return null});for(var h in o)o.hasOwnProperty(h)&&r(o,h)},shaped.importSpell=function(e,t,a,r){function s(e,t){e.damage&&(setAttribute(o+"spell_toggle_"+t+"_damage","@{spell_var_"+t+"_damage}"),setAttribute(o+"spell_"+t+"_dmg",e.damage)),e.damageBonus&&(setAttribute(o+"spell_toggle_bonuses","@{spell_var_bonuses}"),setAttribute(o+"spell_"+t+"_dmg_bonus",e.damageBonus)),e.castingStat&&setAttribute(o+"spell_"+t+"_dmg_stat","@{casting_stat}"),e.damageType&&setAttribute(o+"spell_"+t+"_dmg_type",e.damageType),e.secondaryDamage&&(setAttribute(o+"spell_toggle_"+t+"_second_damage","@{spell_var_"+t+"_second_damage}"),setAttribute(o+"spell_"+t+"_second_dmg",e.secondaryDamage)),e.secondaryDamageType&&setAttribute(o+"spell_"+t+"_second_dmg_type",e.secondaryDamageType),e.higherLevelDice&&(setAttribute(o+"spell_toggle_higher_lvl_query","@{higher_level_query}"),setAttribute(o+"spell_toggle_output_higher_lvl_query","@{spell_var_output_higher_lvl_query}"),setAttribute(o+"spell_"+t+"_higher_level_dmg_dice",e.higherLevelDice)),e.higherLevelDie&&setAttribute(o+"spell_"+t+"_higher_level_dmg_die",e.higherLevelDie),
e.higherLevelSecondaryDice&&setAttribute(o+"spell_"+t+"_second_higher_level_dmg_dice",e.higherLevelSecondaryDice),e.higherLevelSecondaryDie&&setAttribute(o+"spell_"+t+"_second_higher_level_dmg_die",e.higherLevelSecondaryDie)}var i,n=fifthSpells.spells.filter(function(e){return e.name.toLowerCase()===a.toLowerCase()})[0],o="repeating_spellbook";if(!n)return void messageToChat('Error: cannot find a spell by the name of "'+a+'".');if("undefined"==typeof e)return void messageToChat('Error: cannot find a character by the name of "'+t+'".');characterId=e.id,o+=0===n.level?"cantrip_":"level"+n.level+"_";for(var c=0;100>c;c++){var l=findObjs({_type:"attribute",_characterid:characterId,name:o+c+"_spellname"})[0];if(!l){i=c,o+=i+"_";break}}if(setAttribute(o+"spellname",n.name),r[0]&&"prepared"===r[0]&&setAttribute(o+"spellisprepared","on"),n.ritual&&setAttribute(o+"spellritual","{{spellritual=1}}"),n.concentration&&setAttribute(o+"spellconcentration","{{spellconcentration=1}}"),n.school&&setAttribute(o+"spellschool",n.school),n.castingTime&&("reaction"===n.castingTime?setAttribute(o+"spell_casting_time","@{spell_casting_time_reaction_var}"):"bonus"===n.castingTime?setAttribute(o+"spell_casting_time","@{spell_casting_time_bonus_var}"):"action"===n.castingTime?setAttribute(o+"spell_casting_time","@{spell_casting_time_action_var}"):"minute"===n.castingTime?setAttribute(o+"spell_casting_time","@{spell_casting_time_minute_var}"):(setAttribute(o+"spell_casting_time","@{spell_casting_time_longer_var}"),setAttribute(o+"spellcasttime",n.castingTime))),n.range&&setAttribute(o+"spellrange",n.range),n.target&&setAttribute(o+"spelltarget",n.target),n.aoe&&setAttribute(o+"spellaoe",n.aoe),n.components&&(n.components.verbal&&setAttribute(o+"spellcomponents_verbal","@{spellcomponents_verbal_var}"),n.components.somatic&&setAttribute(o+"spellcomponents_somatic","@{spellcomponents_somatic_var}"),n.components.material&&setAttribute(o+"spellcomponents_material","@{spellcomponents_material_var}"),n.components.materialMaterial&&setAttribute(o+"spellcomponents",n.components.materialMaterial)),n.duration&&setAttribute(o+"spellduration",n.duration),n.source&&setAttribute(o+"spellsource",n.source),n.description&&setAttribute(o+"spelldescription",n.description),n.higherLevel){setAttribute(o+"spellhighersloteffect",n.higherLevel);var d=!0;(n.attack&&n.attack.higherLevelDice||n.damage&&n.damage.higherLevelDice||n.save&&n.save.higherLevelDice||n.heal&&(n.heal.higherLevelDice||n.heal.higherLevelAmount))&&(d=!1),n.level>0&&d&&setAttribute(o+"spell_toggle_higher_lvl","@{spell_var_higher_lvl}")}if(n.emote){var h,u,g,p,_=getAttrByName(characterId,"gender","current");_&&_.match(/f|female|girl|woman|feminine/gi)?(h="she",u="her",g="her",p="herself"):(h="he",u="him",g="his",p="himself"),n.emote=n.emote.replace("{{GENDER_PRONOUN_HE_SHE}}",h).replace("{{GENDER_PRONOUN_HIM_HER}}",u).replace("{{GENDER_PRONOUN_HIS_HER}}",g).replace("{{GENDER_PRONOUN_HIMSELF_HERSELF}}",p),setAttribute(o+"spellemote",n.emote),setAttribute(o+"spell_toggle_emote","@{spell_var_emote}")}n.attack&&(setAttribute(o+"attackstat","@{casting_stat}"),setAttribute(o+"spell_toggle_attack","@{spell_var_attack}"),s(n.attack,"attack"),n.attack.damage&&setAttribute(o+"spell_toggle_attack_crit","@{spell_var_attack_crit}")),n.damage&&s(n.damage,"attack"),n.save&&(setAttribute(o+"spell_toggle_save","@{spell_var_save}"),n.save.condition&&setAttribute(o+"savecondition",n.save.condition),n.save.ability&&(setAttribute(o+"savestat",capitalizeFirstLetter(n.save.ability.substring(0,3))),setAttribute(o+"spellsavedc","@{casting_stat_dc}")),n.save.saveFailure&&setAttribute(o+"savefailure",n.save.saveFailure),n.save.saveSuccess&&setAttribute(o+"savesuccess",n.save.saveSuccess),s(n.save,"save")),n.heal&&(setAttribute(o+"spell_toggle_healing","@{spell_var_healing}"),setAttribute(o+"spellhealamount",n.heal.amount),n.heal.bonus&&setAttribute(o+"healbonus",n.heal.bonus),n.heal.castingStat&&setAttribute(o+"healstatbonus","@{casting_stat}"),(n.heal.higherLevelDice||n.heal.higherLevelAmount)&&setAttribute(o+"spell_toggle_higher_lvl_query","@{spell_var_higher_lvl_query}"),n.heal.higherLevelDice&&setAttribute(o+"spell_heal_higher_level_dmg_dice",n.heal.higherLevelDice),n.heal.higherLevelDie&&setAttribute(o+"spell_heal_higher_level_dmg_die",n.heal.higherLevelDie),n.heal.higherLevelAmount&&setAttribute(o+"spell_heal_higher_level_amount",n.heal.higherLevelAmount)),n.effects&&(setAttribute(o+"spelleffect",n.effects),setAttribute(o+"spell_toggle_effects","@{spell_var_effects}")),messageToChat(n.name+" imported for "+t+" on spell level "+n.level+" at index "+i)},shaped.spellImport=function(e,t){var a=t[0].split(", "),r=e.get("represents"),s=findObjs({_type:"character",id:r})[0],i=getAttrByName(r,"character_name","current"),n=[];t[1]&&"prepared"===t[1]&&n.push("prepared");for(var o=0;o<a.length;o++)shaped.importSpell(s,i,a[o],n)},shaped.importMonster=function(e,t){var a=fifthMonsters.monsters.filter(function(e){return e.name.toLowerCase()===t.toLowerCase()})[0];return a?void console.log("monsterName",t):void messageToChat('Error: cannot find a monster by the name of "'+t+'".')},shaped.monsterImport=function(e,t){var a=t[0];t[1]&&"clean"===t[1]&&shaped.deleteOldSheetByName(a),shaped.importMonster(e,a)}}("undefined"==typeof shaped?shaped={}:shaped),on("ready",function(){"use strict";shaped.statblock.RegisterHandlers()});